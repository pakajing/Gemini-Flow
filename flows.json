[
    {
        "id": "3887a97abab1ae29",
        "type": "tab",
        "label": "Secret Manager",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "bb119fa58e5b3485",
        "type": "tab",
        "label": "Iconik to Gemini",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "97b77bc4b98052be",
        "type": "subflow",
        "name": "Get Global Secret",
        "info": "# Flow Get Secrets\r\n\r\n## Description\r\nThis flow retrieves secrets related to Confluence and Pinecone (email, token, URL, and API key) from the global context (`global.get`) and validates their presence. If any secret is missing, an error is returned with a descriptive message.\r\n\r\n## Input\r\n- **Trigger:**\r\n  - No specific input is required. The function node retrieves secrets from the global context.\r\n- **Context / Global Vars:**\r\n  - `SECRETS.confluence_email`\r\n  - `SECRETS.confluence_token`\r\n  - `SECRETS.confluence_url`\r\n  - `SECRETS.pinecone_ApiKey`\r\n- **Expected Secrets:**\r\n  - `confluence_email`: The email address for Confluence authentication.\r\n  - `confluence_token`: The API token for Confluence authentication.\r\n  - `confluence_url`: The base URL for the Confluence API.\r\n  - `pinecone_ApiKey`: The API key for Pinecone services.\r\n\r\n## Output\r\n- **Success Path:**\r\n  - If all secrets are present:\r\n    - `msg.secret` contains the retrieved secrets as an object:\r\n      ```json\r\n      {\r\n        \"confluence_email\": \"...\",\r\n        \"confluence_token\": \"...\",\r\n        \"confluence_url\": \"...\",\r\n        \"pinecone_apiKey\": \"...\"\r\n      }\r\n      ```\r\n    - `msg.statusCode` is set to `200`.\r\n    - The message is sent to Output 1.\r\n- **Error Path:**\r\n  - If any secret is missing:\r\n    - `msg.error` contains a descriptive error message (e.g., `Global.SECRETS.confluence_email is not set. Please Check Space SECRET`).\r\n    - `msg.statusCode` is set to `404`.\r\n    - The message is sent to Output 2.\r\n\r\n## Notes\r\n> - Ensure that the required secrets are properly configured in the global context before using this flow.\r\n> - This flow is critical for ensuring secure and authenticated interactions with Confluence and Pinecone APIs.\r\n\r\n## Author\r\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\r\n\r\n## qibb Docs\r\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)",
        "category": "",
        "in": [
            {
                "x": 120,
                "y": 220,
                "wires": [
                    {
                        "id": "3f9e95e7f7a71ea7"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 360,
                "y": 180,
                "wires": [
                    {
                        "id": "3f9e95e7f7a71ea7",
                        "port": 0
                    }
                ]
            },
            {
                "x": 360,
                "y": 260,
                "wires": [
                    {
                        "id": "3f9e95e7f7a71ea7",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DEBD5C",
        "icon": "font-awesome/fa-database",
        "status": {
            "x": 280,
            "y": 80,
            "wires": [
                {
                    "id": "4f68b793021e13a7",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "0876dbcda80b1dec",
        "type": "subflow",
        "name": "Gemini",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "59b02e1c91e53481"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 760,
                "y": 40,
                "wires": [
                    {
                        "id": "2bbab8881ba82345",
                        "port": 0
                    }
                ]
            },
            {
                "x": 760,
                "y": 120,
                "wires": [
                    {
                        "id": "64b27d75ce428fdf",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#FFFFFF",
        "icon": "google-gemini-nodes/icon.svg",
        "status": {
            "x": 320,
            "y": 180,
            "wires": [
                {
                    "id": "03f3f26fe7caf8ee",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "fec23f0ed22e717d",
        "type": "subflow",
        "name": "Processing Video Option(s)",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 100,
                "wires": [
                    {
                        "id": "38e1799bc51ee9bf"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1700,
                "y": 40,
                "wires": [
                    {
                        "id": "b7eb442e8678853c",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1700,
                "y": 120,
                "wires": [
                    {
                        "id": "cc05ebf194dc733c",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [
            {
                "name": "HIGHLIGHTS",
                "type": "bool",
                "value": "false",
                "ui": {
                    "label": {
                        "en-US": "Highlights"
                    },
                    "type": "checkbox"
                }
            },
            {
                "name": "KEYWORDS",
                "type": "bool",
                "value": "false",
                "ui": {
                    "label": {
                        "en-US": "Keywords"
                    },
                    "type": "checkbox"
                }
            },
            {
                "name": "SUMMARY",
                "type": "bool",
                "value": "false",
                "ui": {
                    "label": {
                        "en-US": "Summary"
                    },
                    "type": "checkbox"
                }
            },
            {
                "name": "CAPTIONING",
                "type": "bool",
                "value": "false",
                "ui": {
                    "label": {
                        "en-US": "Video Captioning"
                    },
                    "type": "checkbox"
                }
            },
            {
                "name": "ACTION_RECOGNITION",
                "type": "bool",
                "value": "false",
                "ui": {
                    "label": {
                        "en-US": "Action Recognition"
                    },
                    "type": "checkbox"
                }
            }
        ],
        "meta": {},
        "color": "#FFFFFF",
        "icon": "google-gemini-nodes/icon.svg",
        "status": {
            "x": 280,
            "y": 180,
            "wires": [
                {
                    "id": "8cec81fe905fcb0c",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "269b642acef88503",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[0] Webhook Receive",
        "style": {
            "label": true
        },
        "nodes": [
            "ccf39b06e755c073",
            "a403b999625db33d",
            "c94ee39be02badaa",
            "7fc236749081c4f8",
            "6ebb50cb76f0c2ec"
        ],
        "x": 74,
        "y": 39,
        "w": 342,
        "h": 262
    },
    {
        "id": "4e89c03817358d25",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[2] Iconik Auth",
        "style": {
            "label": true
        },
        "nodes": [
            "84e099d8f84ae022",
            "80b502eb86aee4bc",
            "f4319404be2c2735",
            "26f513247a55ca64",
            "73f1b5ffaabb36a3"
        ],
        "x": 714,
        "y": 39,
        "w": 252,
        "h": 262
    },
    {
        "id": "d29e7cdb2d5dd084",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[0] Manual payload",
        "style": {
            "label": true
        },
        "nodes": [
            "inject_asset_id",
            "template_create_payload",
            "187792eede51b3c7",
            "4ba858c9bd77a3a7",
            "6ce865beef8237c8"
        ],
        "x": 74,
        "y": 359,
        "w": 272,
        "h": 202
    },
    {
        "id": "d69961b899aa3d05",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[1] Get Secret",
        "style": {
            "label": true
        },
        "nodes": [
            "13443591230511c3",
            "7216e47d5518efdb",
            "29ee64773863c673",
            "b0f74a4e97da0dc1"
        ],
        "x": 434,
        "y": 39,
        "w": 252,
        "h": 262,
        "info": "# Flow Get Secrets\n\n## Description\nThis flow retrieves secrets related to Gemini and Iconik from the global context (`global.get`) and validates their presence. If any secret is missing, an error is returned with a descriptive message. The retrieved secrets are then packaged into a `msg.secret` object for further use.\n\n## Nodes\n| Node ID | Node Type | Node Name |\n|---------|-----------|-----------|\n| 4f68b793021e13a7 | status     | (Unnamed) |\n| 3f9e95e7f7a71ea7 | function   | Get Secrets |\n| f9847233de5b9a97 | comment    | [1] 📖 Doc - Get Secrets |\n\n## Input\n- **Trigger:**\n  - No specific input is required. The function node retrieves secrets from the global context.\n- **Context / Global Vars:**\n  - `SECRETS.GEMINI_API_KEY`\n  - `SECRETS.GEMINI_MODEL`\n  - `SECRETS.ICONIK_BASE_URL`\n  - `SECRETS.ICONIK_PASSWORD`\n  - `SECRETS.ICONIK_USERNAME`\n\n## Output\n- **Success Path:**\n  - If all secrets are present:\n    - `msg.secret` contains the retrieved secrets as an object:\n      ```json\n      {\n        \"GeminiApiKey\": \"...\",\n        \"GeminiModel\": \"...\",\n        \"IconikBaseUrl\": \"...\",\n        \"IconikPassword\": \"...\",\n        \"IconikUsername\": \"...\"\n      }\n      ```\n    - `msg.statusCode` is set to `200`.\n    - The message is sent to Output 1.\n- **Error Path:**\n  - If any secret is missing:\n    - `msg.error` contains a descriptive error message (e.g., `Global.SECRETS.GEMINI_API_KEY is not set. Please Check Space SECRET`).\n    - `msg.statusCode` is set to `404`.\n    - The message is sent to Output 2.\n\n## Notes\n> - Ensure that the required secrets are properly configured in the global context before using this flow.\n> - This flow is critical for ensuring secure and authenticated interactions with Gemini and Iconik APIs.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "918806d2d79fe6e6",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[3] Iconik Get Format",
        "style": {
            "label": true
        },
        "nodes": [
            "d7f2baca4a091580",
            "f60f93918df2a827",
            "35b8dea63f9feb3a",
            "c1897c6216b8e8dc",
            "2bf0e9042e6659c6"
        ],
        "x": 994,
        "y": 39,
        "w": 292,
        "h": 262
    },
    {
        "id": "fd02e1eb88ae35ab",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[4] Check MediaType",
        "style": {
            "label": true
        },
        "nodes": [
            "8e41cb773d695eb6",
            "62e2db5dec5eeda8",
            "c6921afbb473bc70",
            "016fac0e773e7897",
            "1af3f73061416777"
        ],
        "x": 1314,
        "y": 39,
        "w": 292,
        "h": 262
    },
    {
        "id": "55b3c47cc59469f5",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[5] Get Proxies",
        "style": {
            "label": true
        },
        "nodes": [
            "378749f3f7f8db51",
            "7e2eb0fab7bc6a69",
            "c8e84af63e546d14",
            "8278629e61d3b099",
            "f4d3219677e48ac3"
        ],
        "x": 1634,
        "y": 39,
        "w": 252,
        "h": 262
    },
    {
        "id": "1eba5f0f11ebce0e",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[6] Mediatype",
        "style": {
            "label": true
        },
        "nodes": [
            "60f01beb32c02861",
            "1912e80aa826d7f5",
            "c17bc71b9a4caec4",
            "c7bd865a40778920"
        ],
        "x": 434,
        "y": 359,
        "w": 252,
        "h": 242
    },
    {
        "id": "2b021cccaf858ffb",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "Generate Gemini AI Content",
        "style": {
            "fill": "#001f60",
            "label": true,
            "fill-opacity": "0.5"
        },
        "nodes": [
            "fba603dcc61e0e8c",
            "e77a15478f3fd4a8",
            "4e556b99f052016d"
        ],
        "x": 494,
        "y": 1699,
        "w": 432,
        "h": 202
    },
    {
        "id": "4a5f270e7e34714c",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[7] Download Proxy",
        "style": {
            "label": true
        },
        "nodes": [
            "ea7e0cc8aa8ba6ab",
            "711b16e72058a346",
            "558efa184d525b6e",
            "5e89b3dbf89ae519",
            "13bc77fc3b58b316"
        ],
        "x": 714,
        "y": 359,
        "w": 292,
        "h": 242
    },
    {
        "id": "c69e9338a69f4b55",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "8 check size",
        "style": {
            "label": true
        },
        "nodes": [
            "766a3fcca5fb2b44",
            "e98a084b941a301b",
            "b31beec551160cc2"
        ],
        "x": 1094,
        "y": 819,
        "w": 672,
        "h": 109.5
    },
    {
        "id": "a4b528dbe3ac6232",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "10 check file size and state",
        "style": {
            "label": true
        },
        "nodes": [
            "7c4629e2b4e1baf0",
            "dc0c5588c30a29c5",
            "f0d85a75e3e8494c",
            "49f0f0fa0dc4bcd7"
        ],
        "x": 894,
        "y": 679,
        "w": 1052,
        "h": 82
    },
    {
        "id": "beccbfe6d618a7ca",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "10-1 Check state",
        "style": {
            "label": true
        },
        "nodes": [
            "41dc5b97da49fd1d",
            "0efcf4cff626690b",
            "f509407a070a4c76",
            "28d6c48d41f27f7f",
            "35e25fd2f23e27c7",
            "24aa412b7d47c7c6",
            "cf48b48773b9aed4",
            "d8fcce508cc82af4"
        ],
        "x": 1824,
        "y": 779,
        "w": 362,
        "h": 202
    },
    {
        "id": "0c53975c6ac43f46",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "11 fetch info",
        "style": {
            "label": true
        },
        "nodes": [
            "056246df9904ea45",
            "aa06e61eb146281c",
            "8f14f2d0ab60c0d3",
            "c6480ce55b348f13",
            "7d223f269faec961",
            "0a00ea4d7c10bef4",
            "26b4a64ae183c139",
            "6f1cabb71c4652da",
            "41c5a0c10342a1bc",
            "7dea554c6ac7de37",
            "68bcce7fd6fe1421"
        ],
        "x": 934,
        "y": 1219,
        "w": 1132,
        "h": 202
    },
    {
        "id": "2e5787e38e3bb178",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[8] Upload Proxy",
        "style": {
            "label": true
        },
        "nodes": [
            "6b790f2d4a4bf3e0",
            "f1a2b3c4d5e67890",
            "6db4c154c084378c",
            "38880de9afe4fd3a",
            "01b66cb140e416c2",
            "3510ebc7baaa1485",
            "f5c76e4a184c6ffd",
            "bffb661f516fb5b5",
            "aea43ccdf90168cd"
        ],
        "x": 1034,
        "y": 359,
        "w": 362,
        "h": 242
    },
    {
        "id": "0c30a2997401eb5a",
        "type": "group",
        "z": "bb119fa58e5b3485",
        "name": "[9] Get File",
        "style": {
            "label": true
        },
        "nodes": [
            "737e8c1dced31d50",
            "8d519cd6a3836e1c",
            "24ec17f135c032fd",
            "f7237e0709b112c6",
            "de764c04e9e20758",
            "87ba8df0de8b710d",
            "49237eea06f5ac58",
            "c60188f556a94408",
            "40c124dd6121de0e",
            "b55083f2ef45d619"
        ],
        "x": 1414,
        "y": 359,
        "w": 402,
        "h": 242
    },
    {
        "id": "4f68b793021e13a7",
        "type": "status",
        "z": "97b77bc4b98052be",
        "name": "",
        "scope": null,
        "x": 160,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "3f9e95e7f7a71ea7",
        "type": "function",
        "z": "97b77bc4b98052be",
        "name": "Get Secrets",
        "func": "// Retrieve secrets from global context (Vault)\nvar GeminiApiKey = global.get(\"SECRETS.GEMINI_API_KEY\");\nvar GeminiModel = global.get(\"SECRETS.GEMINI_MODEL\");\nvar IconikBaseUrl = global.get(\"SECRETS.ICONIK_BASE_URL\");\nvar IconikPassword = global.get(\"SECRETS.ICONIK_PASSWORD\");\nvar IconikUsername = global.get(\"SECRETS.ICONIK_USERNAME\");\n\n// Check for each required secret individually\nif (!GeminiApiKey) {\n    node.error(\"❌ Global.SECRETS.GEMINI_API_KEY is not set. Please Check Space SECRET\");\n    msg.error = \"Global.SECRETS.GEMINI_API_KEY is not set. Please Check Space SECRET\";\n    msg.statusCode = 404;\n    return [null, msg]; \n}\n\nif (!GeminiModel) {\n    node.error(\"❌ Global.SECRETS.GEMINI_MODEL is not set. Please Check Space SECRET\");\n    msg.error = \"Global.SECRETS.GEMINI_MODEL is not set. Please Check Space SECRET\";\n    msg.statusCode = 404;\n    return [null, msg];\n}\n\nif (!IconikBaseUrl) {\n    node.error(\"❌ Global.SECRETS.ICONIK_BASE_URL is not set. Please Check Space SECRET\");\n    msg.error = \"Global.SECRETS.ICONIK_BASE_URL is not set. Please Check Space SECRET\";\n    msg.statusCode = 404;\n    return [null, msg];\n}\n\nif (!IconikPassword) {\n    node.error(\"❌ Global.SECRETS.ICONIK_PASSWORD is not set. Please Check Space SECRET\");\n    msg.error = \"Global.SECRETS.ICONIK_PASSWORD is not set. Please Check Space SECRET\";\n    msg.statusCode = 404;\n    return [null, msg];\n}\n\nif (!IconikUsername) {\n    node.error(\"❌ Global.SECRETS.ICONIK_USERNAME is not set. Please Check Space SECRET\");\n    msg.error = \"Global.SECRETS.ICONIK_USERNAME is not set. Please Check Space SECRET\";\n    msg.statusCode = 404;\n    return [null, msg];\n}\n\n// Construct the message secret\nmsg.secret = {\n    \"GeminiApiKey\": GeminiApiKey,\n    \"GeminiModel\": GeminiModel,\n    \"IconikBaseUrl\": IconikBaseUrl,\n    \"IconikPassword\": IconikPassword,\n    \"IconikUsername\": IconikUsername\n};\n\nmsg.statusCode = 200;\n\nreturn [msg, null]; // All good, send to output 1\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 220,
        "wires": [
            [],
            []
        ],
        "info": "# Flow Get Secrets\n\n## Description\nThis flow retrieves secrets related to Confluence and Pinecone (email, token, URL, and API key) from the global context (`global.get`) and validates their presence. If any secret is missing, an error is returned with a descriptive message.\n\n## Input\n- **Trigger:**\n  - No specific input is required. The function node retrieves secrets from the global context.\n- **Context / Global Vars:**\n  - `SECRETS.confluence_email`\n  - `SECRETS.confluence_token`\n  - `SECRETS.confluence_url`\n  - `SECRETS.pinecone_ApiKey`\n- **Expected Secrets:**\n  - `confluence_email`: The email address for Confluence authentication.\n  - `confluence_token`: The API token for Confluence authentication.\n  - `confluence_url`: The base URL for the Confluence API.\n  - `pinecone_ApiKey`: The API key for Pinecone services.\n\n## Output\n- **Success Path:**\n  - If all secrets are present:\n    - `msg.secret` contains the retrieved secrets as an object:\n      ```json\n      {\n        \"confluence_email\": \"...\",\n        \"confluence_token\": \"...\",\n        \"confluence_url\": \"...\",\n        \"pinecone_apiKey\": \"...\"\n      }\n      ```\n    - `msg.statusCode` is set to `200`.\n    - The message is sent to Output 1.\n- **Error Path:**\n  - If any secret is missing:\n    - `msg.error` contains a descriptive error message (e.g., `Global.SECRETS.confluence_email is not set. Please Check Space SECRET`).\n    - `msg.statusCode` is set to `404`.\n    - The message is sent to Output 2.\n\n## Notes\n> - Ensure that the required secrets are properly configured in the global context before using this flow.\n> - This flow is critical for ensuring secure and authenticated interactions with Confluence and Pinecone APIs.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "a1b2c3d4e5f67890",
        "type": "comment",
        "z": "97b77bc4b98052be",
        "name": "[1] 📖 Doc - Get Secrets",
        "info": "# Flow Get Secrets\n\n## Description\nThis flow retrieves secrets related to Gemini and Iconik from the global context (`global.get`) and validates their presence. If any secret is missing, an error is returned with a descriptive message. The retrieved secrets are then packaged into a `msg.secret` object for further use.\n\n## Nodes\n| Node ID | Node Type | Node Name |\n|---------|-----------|-----------|\n| 4f68b793021e13a7 | status     | (Unnamed) |\n| 3f9e95e7f7a71ea7 | function   | Get Secrets |\n| f9847233de5b9a97 | comment    | [1] 📖 Doc - Get Secrets |\n\n## Input\n- **Trigger:**\n  - No specific input is required. The function node retrieves secrets from the global context.\n- **Context / Global Vars:**\n  - `SECRETS.GEMINI_API_KEY`\n  - `SECRETS.GEMINI_MODEL`\n  - `SECRETS.ICONIK_BASE_URL`\n  - `SECRETS.ICONIK_PASSWORD`\n  - `SECRETS.ICONIK_USERNAME`\n\n## Output\n- **Success Path:**\n  - If all secrets are present:\n    - `msg.secret` contains the retrieved secrets as an object:\n      ```json\n      {\n        \"GeminiApiKey\": \"...\",\n        \"GeminiModel\": \"...\",\n        \"IconikBaseUrl\": \"...\",\n        \"IconikPassword\": \"...\",\n        \"IconikUsername\": \"...\"\n      }\n      ```\n    - `msg.statusCode` is set to `200`.\n    - The message is sent to Output 1.\n- **Error Path:**\n  - If any secret is missing:\n    - `msg.error` contains a descriptive error message (e.g., `Global.SECRETS.GEMINI_API_KEY is not set. Please Check Space SECRET`).\n    - `msg.statusCode` is set to `404`.\n    - The message is sent to Output 2.\n\n## Notes\n> - Ensure that the required secrets are properly configured in the global context before using this flow.\n> - This flow is critical for ensuring secure and authenticated interactions with Gemini and Iconik APIs.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)",
        "x": 480,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "59b02e1c91e53481",
        "type": "http request",
        "z": "0876dbcda80b1dec",
        "name": "Gemini Request",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "x-goog-api-key",
                "valueType": "msg",
                "valueValue": "apiKey"
            }
        ],
        "x": 200,
        "y": 80,
        "wires": [
            [
                "8a1b82da44edc556"
            ]
        ]
    },
    {
        "id": "8a1b82da44edc556",
        "type": "switch",
        "z": "0876dbcda80b1dec",
        "name": "Success?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "200",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 360,
        "y": 80,
        "wires": [
            [
                "2bbab8881ba82345"
            ],
            [
                "64b27d75ce428fdf"
            ]
        ]
    },
    {
        "id": "64b27d75ce428fdf",
        "type": "function",
        "z": "0876dbcda80b1dec",
        "name": "Set Error Status",
        "func": "const errorMsg = \"Gemini Error\"\nnode.status({fill:\"red\",shape:\"ring\",text:errorMsg});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "2bbab8881ba82345",
        "type": "function",
        "z": "0876dbcda80b1dec",
        "name": "Set Success Status",
        "func": "node.status({fill:\"green\",shape:\"ring\",text:\"Success\"});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "03f3f26fe7caf8ee",
        "type": "status",
        "z": "0876dbcda80b1dec",
        "name": "",
        "scope": null,
        "x": 200,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "a0d786322aa3b0e6",
        "type": "template",
        "z": "fec23f0ed22e717d",
        "name": "Set Prompt",
        "field": "userPrompt",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "Using the provided video and selected options, generate text content that accurately represents the relevant details for each option while adhering to the given formats. \nEnsure that each object is formatted properly and that redundant information is avoided.\nDo not use Markdown formatting in your output.\n\nFor each selected option, use the corresponding format as outlined below:\n-Selected options: {{{selectedOptions}}}\n-Expected format: {{{formats}}}\n\nIf no relevant results are available for any selected option, return the following format: {{noResultsFormat}}, indicating that no relevant data could be generated for the option.",
        "output": "str",
        "x": 550,
        "y": 80,
        "wires": [
            [
                "273e62a62521a006"
            ]
        ]
    },
    {
        "id": "d991eb2e4d23ab66",
        "type": "change",
        "z": "fec23f0ed22e717d",
        "name": "Save Response",
        "rules": [
            {
                "t": "set",
                "p": "responseText.content",
                "pt": "msg",
                "to": "payload.candidates[0].content.parts[0].text",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "responseText.safetyRatings",
                "pt": "msg",
                "to": "payload.candidates[0].safetyRatings",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "responseUrl",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "userPrompt",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "url",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "apiKey",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "uploadResponse",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "mediaType",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filename",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "model",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "mediaType",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "displayName",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "noResultsFormat",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "formats",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "headers",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "fileUri",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "uploadFileName",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "retry",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "redirectList",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1420,
        "y": 40,
        "wires": [
            [
                "b7eb442e8678853c"
            ]
        ]
    },
    {
        "id": "38e1799bc51ee9bf",
        "type": "function",
        "z": "fec23f0ed22e717d",
        "name": "Check Selected Option",
        "func": "const highlights = env.get(\"HIGHLIGHTS\"); \nconst keywords = env.get(\"KEYWORDS\");\nconst summary = env.get(\"SUMMARY\");\nconst captioning = env.get(\"CAPTIONING\");\nconst actionRecognition = env.get(\"ACTION_RECOGNITION\")\nconst selectedOptions = [];\n\nmsg.model = global.get(\"SECRETS.GEMINI_MODEL\")\n\n// Determine the selected options\nif (highlights) {\n  selectedOptions.push(\"Highlights\");\n}\nif (keywords) {\n  selectedOptions.push(\"Keywords\");\n}\nif (summary) {\n  selectedOptions.push(\"Summary\");\n}\nif(captioning){\n  selectedOptions.push(\"Video Captioning\");\n}\nif(actionRecognition){\n  selectedOptions.push(\"Video Action Recognition\");\n}\n\nmsg.selectedOptions = selectedOptions\n\n// Validate that at least one option is selected\nif (!highlights && !keywords && !summary) {\n  const errorMsg = \"You must select at least one option\";\n  node.error(errorMsg);\n  node.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n  setTimeout(() => node.status({}), 2000);\n  return [null, msg];\n}\n\n// Validate the model presence\nif (!msg.model) {\n  const errorMsg = \"You must provide a Gemini Model\";\n  node.error(errorMsg);\n  node.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n  \n  setTimeout(() => node.status({}), 2000);\n  return [null, msg];\n}\n\nreturn [msg, null];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 100,
        "wires": [
            [
                "9f2d542864f19abd"
            ],
            [
                "cc05ebf194dc733c"
            ]
        ]
    },
    {
        "id": "273e62a62521a006",
        "type": "template",
        "z": "fec23f0ed22e717d",
        "name": "Set Payload",
        "field": "payload",
        "fieldType": "msg",
        "format": "json",
        "syntax": "mustache",
        "template": "{\n    \"contents\": [\n        {\n            \"parts\": [\n                {\n                    \"fileData\": {\n                        \"mimeType\": \"{{{mediaType}}}\",\n                        \"fileUri\": \"{{{fileUri}}}\"\n                    }\n                }\n            ],\n            \"role\": \"user\"\n        },\n        {\n            \"parts\": [\n                {\n                    \"text\": \"{{{userPrompt}}}\"\n                }\n            ],\n            \"role\": \"user\"\n        }\n    ]\n}",
        "output": "json",
        "x": 710,
        "y": 80,
        "wires": [
            [
                "bb39e70e1554cbe9"
            ]
        ]
    },
    {
        "id": "8cec81fe905fcb0c",
        "type": "status",
        "z": "fec23f0ed22e717d",
        "name": "",
        "scope": null,
        "x": 180,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "cc05ebf194dc733c",
        "type": "function",
        "z": "fec23f0ed22e717d",
        "name": "Set Error Response",
        "func": "const errorMsg = \"Gemini Error\"\nnode.status({fill:\"red\",shape:\"ring\",text:errorMsg});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1210,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "17540a8355017c39",
        "type": "function",
        "z": "fec23f0ed22e717d",
        "name": "Set Success Response",
        "func": "node.status({fill:\"green\",shape:\"ring\",text:\"Success\"});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 40,
        "wires": [
            [
                "d991eb2e4d23ab66"
            ]
        ]
    },
    {
        "id": "9f2d542864f19abd",
        "type": "function",
        "z": "fec23f0ed22e717d",
        "name": "Set Formats ",
        "func": "const selectedOptions = msg.selectedOptions;\nconst outputFormats = {};\n\n// Check for Object Detection\nif (selectedOptions.includes(\"Highlights\")) {\n  const highlightsFormat = [\n    {\n      \"highlight\": \"[Brief description of the important moments]\",\n      \"timestamp\": \"[Timestamp for the start and end time of the highlight in the format HH:MM:SS]\",\n      \"duration\": \"Duration of the highlight in the video\"\n    }\n  ];\n  outputFormats.highlights = highlightsFormat;\n}\n\n// Check for Optical Character Recognition (OCR)\nif (selectedOptions.includes(\"Summary\")) {\n  const summaryFormat = \"Provide a detailed summary of the key events, scenes, and main content of the video\";\n  outputFormats.summary = summaryFormat;\n}\n\n// Check for Description\nif (selectedOptions.includes(\"Keywords\")) {\n  const keywordsFormat = [\n  \"Generate a list of most relevant keywords or topics related to the video content\"\n  ];\n  outputFormats.keywords = keywordsFormat;\n}\n\n// Check for Video Captioning \nif (selectedOptions.includes(\"Video Captioning\")){\n  const videoCaptioningFormat = [\n    {\n      \"timestamp\": \"[Time in the video, e.g., '00:01:23']\",\n      \"sceneDescription\": {\n        \"overall\": \"[Description of the environment, e.g., 'A sunny park with children playing in the background']\",\n        \"objects\": [\n          {\n            \"objectName\": \"[Name of detected object, e.g., 'dog', 'tree']\",\n            \"position\": \"[Position of the object in the frame, e.g., 'center', 'top-left']\"\n          }\n        ]\n      }\n    }\n  ]\n  outputFormats.videoCaptioning = videoCaptioningFormat\n}\n\n// Check for Video Action Recognition \nif (selectedOptions.includes(\"Video Action Recognition\")){\n  const actionRecognitionFormat = [\n    {\n      \"timestamp\": \"[Time in the video, e.g., '00:02:05']\",\n      \"action\": \"[Detected action, e.g., 'running', 'jumping', etc...]\",\n      \"subject\": \"[Who is performing the action, e.g., 'man', 'child']\",\n      \"duration\": \"[Duration of the action in seconds, e.g., '3.5 seconds']\",\n      \"objectInteraction\": \"[Object being interacted with, if any, e.g., 'holding a tennis racket']\"\n    }\n  ]\n  outputFormats.actionRecognition = actionRecognitionFormat\n}\n\n// No Results Format\nconst noResultsFormat = [\n  {\n    \"option\": \"[Selected option]\",\n    \"message\": \"No descriptive content could be generated for this image.\"\n  }\n];\n\nmsg.noResultsFormat = JSON.stringify(noResultsFormat, null, 2);\nconst formattedOutput = JSON.stringify(outputFormats, null, 2);\n\nmsg.formats = formattedOutput;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 80,
        "wires": [
            [
                "a0d786322aa3b0e6"
            ]
        ]
    },
    {
        "id": "bb39e70e1554cbe9",
        "type": "change",
        "z": "fec23f0ed22e717d",
        "name": "Set Url",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "https://generativelanguage.googleapis.com/v1beta/models/\" & model & \":generateContent",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "authHeaders",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 80,
        "wires": [
            [
                "99b6ba68b4ce8716"
            ]
        ]
    },
    {
        "id": "b7eb442e8678853c",
        "type": "json",
        "z": "fec23f0ed22e717d",
        "name": "",
        "property": "responseText.content",
        "action": "",
        "pretty": false,
        "x": 1590,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "99b6ba68b4ce8716",
        "type": "subflow:0876dbcda80b1dec",
        "z": "fec23f0ed22e717d",
        "name": "",
        "x": 1020,
        "y": 80,
        "wires": [
            [
                "17540a8355017c39"
            ],
            [
                "cc05ebf194dc733c"
            ]
        ]
    },
    {
        "id": "413d709fa3d4b4a0",
        "type": "qibb-secret-manager-sync",
        "z": "3887a97abab1ae29",
        "name": "",
        "SYNC_PERIOD": "30min",
        "SYNC_ON_DEPLOY": true,
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "ccf39b06e755c073",
        "type": "http in",
        "z": "bb119fa58e5b3485",
        "g": "269b642acef88503",
        "name": "",
        "url": "webhooks/vision",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 200,
        "wires": [
            [
                "a403b999625db33d",
                "c94ee39be02badaa",
                "6ebb50cb76f0c2ec"
            ]
        ]
    },
    {
        "id": "a403b999625db33d",
        "type": "http response",
        "z": "bb119fa58e5b3485",
        "g": "269b642acef88503",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 235,
        "y": 260,
        "wires": [],
        "l": false
    },
    {
        "id": "c94ee39be02badaa",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "269b642acef88503",
        "name": "Debug OK: Webhook Receive",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload.asset_ids[0]",
        "statusType": "msg",
        "x": 275,
        "y": 140,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "7fc236749081c4f8",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "269b642acef88503",
        "name": "[0] 📖 Doc - Webhook Receive",
        "info": "",
        "x": 260,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "84e099d8f84ae022",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "4e89c03817358d25",
        "name": "Save Auth Headers",
        "rules": [
            {
                "t": "set",
                "p": "authHeaders",
                "pt": "msg",
                "to": "headers",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 915,
        "y": 200,
        "wires": [
            [
                "f60f93918df2a827"
            ]
        ],
        "l": false
    },
    {
        "id": "f4319404be2c2735",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "4e89c03817358d25",
        "name": "Debug Error: Auth Iconik",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 835,
        "y": 260,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "26f513247a55ca64",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "4e89c03817358d25",
        "name": "Debug OK: Auth Iconik",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 835,
        "y": 140,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "73f1b5ffaabb36a3",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "4e89c03817358d25",
        "name": "[2] 📖 Doc - Iconik Auth",
        "info": "",
        "x": 840,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "inject_asset_id",
        "type": "inject",
        "z": "bb119fa58e5b3485",
        "g": "d29e7cdb2d5dd084",
        "name": "Inject Asset ID",
        "props": [
            {
                "p": "asset_id",
                "v": "24b04584-6ea2-11ef-ae2e-c66babe23967",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 135,
        "y": 520,
        "wires": [
            [
                "template_create_payload"
            ]
        ],
        "l": false
    },
    {
        "id": "template_create_payload",
        "type": "template",
        "z": "bb119fa58e5b3485",
        "g": "d29e7cdb2d5dd084",
        "name": "Build Full Payload",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{\n  \"user_id\": \"49c7bd08-0e06-11f0-a1f8-a6363a946122\",\n  \"system_domain_id\": \"9e392c9c-e28e-11ec-8906-82ba1484052f\",\n  \"context\": \"ASSET\",\n  \"action_id\": \"66ed6750-459f-11ef-afd9-1ec546efc4f6\",\n  \"asset_ids\": [\"{{asset_id}}\"],\n  \"collection_ids\": [],\n  \"saved_search_ids\": [],\n  \"metadata_view_id\": null,\n  \"metadata_values\": null,\n  \"date_created\": \"2025-06-04T07:20:34.362212\"\n}",
        "output": "json",
        "x": 195,
        "y": 520,
        "wires": [
            [
                "6ce865beef8237c8"
            ]
        ],
        "l": false
    },
    {
        "id": "187792eede51b3c7",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "d29e7cdb2d5dd084",
        "name": "[0] 📖 Doc - Manual payload",
        "info": "",
        "x": 210,
        "y": 400,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "80b502eb86aee4bc",
        "type": "iconik-auth",
        "z": "bb119fa58e5b3485",
        "g": "4e89c03817358d25",
        "name": "",
        "ICONIK_BASE_URL": "https://app.iconik.io",
        "ICONIK_EMAIL": "r.holzhause@techtriq.com",
        "ICONIK_PASSWORD": {
            "type": "cred",
            "value": "ftoeK1ytV9iG89GEFZagD2vHfbLncmuA0t6uyzrvTEtoBTRPVzCB6br8UM3jvPzk"
        },
        "x": 835,
        "y": 200,
        "wires": [
            [
                "84e099d8f84ae022",
                "26f513247a55ca64"
            ],
            [
                "f4319404be2c2735"
            ]
        ],
        "l": false
    },
    {
        "id": "13443591230511c3",
        "type": "subflow:97b77bc4b98052be",
        "z": "bb119fa58e5b3485",
        "g": "d69961b899aa3d05",
        "name": "",
        "x": 555,
        "y": 200,
        "wires": [
            [
                "7216e47d5518efdb",
                "80b502eb86aee4bc"
            ],
            [
                "29ee64773863c673"
            ]
        ],
        "l": false,
        "info": "# Flow Get Secrets\n\n## Description\nThis flow retrieves Confluence-related secrets (email, token, and URL) from the global context (`global.get`) and validates their presence. If any secret is missing, an error is returned with a descriptive message.\n\n## Input\n- **Trigger:**\n  - No specific input is required. The function node retrieves secrets from the global context.\n- **Context / Global Vars:**\n  - `SECRETS.confluence_email`\n  - `SECRETS.confluence_token`\n  - `SECRETS.confluence_url`\n- **Expected Secrets:**\n  - `confluence_email`: The email address for Confluence authentication.\n  - `confluence_token`: The API token for Confluence authentication.\n  - `confluence_url`: The base URL for the Confluence API.\n\n## Output\n- **Success Path:**\n  - If all secrets are present:\n    - `msg.secret` contains the retrieved secrets as an object:\n      ```json\n      {\n        \"confluence_email\": \"...\",\n        \"confluence_token\": \"...\",\n        \"confluence_url\": \"...\"\n      }\n      ```\n    - `msg.statusCode` is set to `200`.\n    - The message is sent to Output 1.\n- **Error Path:**\n  - If any secret is missing:\n    - `msg.error` contains a descriptive error message (e.g., `Global.SECRETS.confluence_email is not set. Please Check Space SECRET`).\n    - `msg.statusCode` is set to `404`.\n    - The message is sent to Output 2.\n\n## Notes\n> - Ensure that the required secrets are properly configured in the global context before using this flow.\n> - This flow is critical for ensuring secure and authenticated interactions with the Confluence API.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)\n"
    },
    {
        "id": "7216e47d5518efdb",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "d69961b899aa3d05",
        "name": "Debug OK: Get Secret",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 555,
        "y": 140,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false,
        "info": "# Flow Debug Get Secret\n\n## Description\nThis `Debug` node is used to verify the successful retrieval of secrets. It logs the full message object (`msg`) to the debug sidebar and displays the `msg.statusCode` in the node's status field for quick monitoring.\n\n## Input\n- **Trigger:**\n  - The node is triggered by the output of a preceding node in the flow, typically after a secret retrieval process.\n- **Context / Global Vars:** None required.\n- **Expected Secrets:** None required.\n\n## Output\n- **Success Path:**\n  - Logs the full incoming message (`msg`) to the debug sidebar.\n  - Displays the `msg.statusCode` in the node's status field for quick reference.\n  - Outputs the message for further processing if connected downstream.\n- **Error Path:**\n  - This node does not handle errors but can be used to inspect issues in the incoming message.\n\n## Notes\n> - The debug node is disabled by default. Enable it to view logs in the debug sidebar.\n> - Use this node during development or troubleshooting to ensure secrets are being retrieved and processed correctly.\n> - The `msg.statusCode` is displayed in the node's status field for quick monitoring of the HTTP response status.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)\n"
    },
    {
        "id": "29ee64773863c673",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "d69961b899aa3d05",
        "name": "Debug Error: Get Secret",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 555,
        "y": 260,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false,
        "info": "# Flow Debug Error Get Secret\n\n## Description\nThis `Debug` node is used to log and inspect errors that occur during the secret retrieval process. It captures the full message object (`msg`) and displays the `msg.statusCode` in the node's status field for quick monitoring.\n\n## Input\n- **Trigger:**\n  - The node is triggered by the output of a preceding node in the flow, typically when an error occurs during secret retrieval.\n- **Context / Global Vars:** None required.\n- **Expected Secrets:** None required.\n\n## Output\n- **Success Path:**\n  - Logs the full incoming message (`msg`) to the debug sidebar for inspection.\n  - Displays the `msg.statusCode` in the node's status field for quick reference.\n  - Outputs the message for further processing if connected downstream.\n- **Error Path:**\n  - This node does not handle errors but is used to inspect and debug issues in the incoming message.\n\n## Notes\n> - The debug node is enabled by default to assist in troubleshooting.\n> - Use this node during development or troubleshooting to identify and resolve issues in the secret retrieval process.\n> - The `msg.statusCode` is displayed in the node's status field for quick monitoring of the HTTP response status.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)\n"
    },
    {
        "id": "b0f74a4e97da0dc1",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "d69961b899aa3d05",
        "name": "[1] 📖 Doc - Get Secret",
        "info": "# Flow Get Secrets\n\n## Description\nThis flow retrieves secrets related to Gemini and Iconik from the global context (`global.get`) and validates their presence. If any secret is missing, an error is returned with a descriptive message. The retrieved secrets are then packaged into a `msg.secret` object for further use.\n\n## Nodes\n| Node ID | Node Type | Node Name |\n|---------|-----------|-----------|\n| 4f68b793021e13a7 | status     | (Unnamed) |\n| 3f9e95e7f7a71ea7 | function   | Get Secrets |\n| f9847233de5b9a97 | comment    | [1] 📖 Doc - Get Secrets |\n\n## Input\n- **Trigger:**\n  - No specific input is required. The function node retrieves secrets from the global context.\n- **Context / Global Vars:**\n  - `SECRETS.GEMINI_API_KEY`\n  - `SECRETS.GEMINI_MODEL`\n  - `SECRETS.ICONIK_BASE_URL`\n  - `SECRETS.ICONIK_PASSWORD`\n  - `SECRETS.ICONIK_USERNAME`\n\n## Output\n- **Success Path:**\n  - If all secrets are present:\n    - `msg.secret` contains the retrieved secrets as an object:\n      ```json\n      {\n        \"GeminiApiKey\": \"...\",\n        \"GeminiModel\": \"...\",\n        \"IconikBaseUrl\": \"...\",\n        \"IconikPassword\": \"...\",\n        \"IconikUsername\": \"...\"\n      }\n      ```\n    - `msg.statusCode` is set to `200`.\n    - The message is sent to Output 1.\n- **Error Path:**\n  - If any secret is missing:\n    - `msg.error` contains a descriptive error message (e.g., `Global.SECRETS.GEMINI_API_KEY is not set. Please Check Space SECRET`).\n    - `msg.statusCode` is set to `404`.\n    - The message is sent to Output 2.\n\n## Notes\n> - Ensure that the required secrets are properly configured in the global context before using this flow.\n> - This flow is critical for ensuring secure and authenticated interactions with Gemini and Iconik APIs.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)",
        "x": 560,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "4ba858c9bd77a3a7",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "d29e7cdb2d5dd084",
        "name": "Debug OK: Manual Payload",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.webhook.asset_ids[0]",
        "statusType": "msg",
        "x": 275,
        "y": 460,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "6ebb50cb76f0c2ec",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "269b642acef88503",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "iconik.webhook",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 375,
        "y": 200,
        "wires": [
            [
                "13443591230511c3"
            ]
        ],
        "l": false
    },
    {
        "id": "6ce865beef8237c8",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "d29e7cdb2d5dd084",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "iconik.webhook",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 275,
        "y": 520,
        "wires": [
            [
                "4ba858c9bd77a3a7",
                "13443591230511c3"
            ]
        ],
        "l": false
    },
    {
        "id": "d7f2baca4a091580",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "918806d2d79fe6e6",
        "name": "Save Media type",
        "rules": [
            {
                "t": "set",
                "p": "iconik.mediaType",
                "pt": "msg",
                "to": "iconik.output.payload.objects[0].metadata[0].internet_media_type",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "iconik.asset_id",
                "pt": "msg",
                "to": "iconik.webhook.asset_ids[0]",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "headers",
                "pt": "msg",
                "to": "authHeaders",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "iconik.get_format",
                "pt": "msg",
                "to": "iconik.output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1195,
        "y": 200,
        "wires": [
            [
                "62e2db5dec5eeda8"
            ]
        ],
        "l": false
    },
    {
        "id": "f60f93918df2a827",
        "type": "iconik-files-client",
        "z": "bb119fa58e5b3485",
        "g": "918806d2d79fe6e6",
        "name": "GET Asset Formats",
        "selectedOperation": {
            "method": "get",
            "path": "/v1/assets/{asset_id}/formats/",
            "summary": "Get all asset's formats",
            "description": "Get all asset's formats\n\nRequired roles:\n - can_read_formats\n",
            "tag": "Other",
            "operationId": "get_v1_assets__asset_id__formats_"
        },
        "api": "api-0",
        "errorHandlingModeSelectedIndex": 1,
        "security": [],
        "requestContentTypeSelectedIndex": 0,
        "responseContentTypeSelectedIndex": 0,
        "parameters": [
            {
                "name": "asset_id",
                "value": "iconik.webhook.asset_ids[0]",
                "in": "path",
                "refType": "msg"
            },
            {
                "name": "per_page",
                "value": "",
                "in": "query",
                "refType": "type"
            },
            {
                "name": "last_id",
                "value": "",
                "in": "query",
                "refType": "type"
            }
        ],
        "uiFeatures": {
            "operations": {
                "advancedMode": true
            }
        },
        "outputs": 2,
        "output": "iconik.output",
        "host": {
            "type": "string",
            "value": "",
            "refType": "type"
        },
        "x": 1115,
        "y": 200,
        "wires": [
            [
                "35b8dea63f9feb3a",
                "d7f2baca4a091580"
            ],
            [
                "c1897c6216b8e8dc"
            ]
        ],
        "l": false
    },
    {
        "id": "35b8dea63f9feb3a",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "918806d2d79fe6e6",
        "name": "Debug OK: Iconik Get Format",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.output.statusCode",
        "statusType": "msg",
        "x": 1115,
        "y": 140,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "c1897c6216b8e8dc",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "918806d2d79fe6e6",
        "name": "Debug Error: Iconik Get Format",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.output.statusCode",
        "statusType": "msg",
        "x": 1115,
        "y": 260,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "62e2db5dec5eeda8",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "fd02e1eb88ae35ab",
        "name": "Check MediaType",
        "func": "// Define supported media types for images and videos\nconst supportedMediaTypes = {\n  image: [\"image/jpeg\", \"image/png\", \"image/webp\", \"image/heic\", \"image/heif\"],\n  video: [\"video/mp4\", \"video/mpeg\", \"video/mov\", \"video/avi\", \"video/x-flv\", \"video/mpg\", \"video/webm\", \"video/wmx\", \"video/3gpp\"]\n};\n\n// Extract the media type from the incoming message\nconst assetMediaType = msg.iconik.mediaType;\n\n// Function to check if the media type is supported\nconst isSupportedMediaType = (type, mediaType) => supportedMediaTypes[type].includes(mediaType);\n\ntry {\n  // Validate the media type\n  if (!isSupportedMediaType('image', assetMediaType) && !isSupportedMediaType('video', assetMediaType)) {\n    // If unsupported, set the error message and supported media types\n    msg.statusInfo = `The selected asset has a media type of \"${assetMediaType}\", which is not among the supported media types. Please choose a compatible media type.`;\n    msg.supportedMediaTypes = supportedMediaTypes;\n    msg.statusCode = 400; // Set status code for unsupported media type\n    return [null, msg]; // Send to output 2\n  } else {\n    // If supported, set a success message\n    msg.statusInfo = `The selected asset has a supported media type: \"${assetMediaType}\".`;\n    msg.statusCode = 200; // Set status code for supported media type\n    return [msg, null]; // Send to output 1\n  }\n} catch (error) {\n  // Handle unexpected errors\n  node.error(\"An error occurred while checking the media type\", msg);\n  msg.statusInfo = \"An internal error occurred.\";\n  msg.statusCode = 500; // Set status code for internal error\n  return [null, msg]; // Send to output 2\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1455,
        "y": 200,
        "wires": [
            [
                "016fac0e773e7897",
                "1af3f73061416777"
            ],
            [
                "c6921afbb473bc70"
            ]
        ],
        "l": false,
        "info": "# Check MediaType\n\n## Purpose\nThis function node checks if the provided media type is supported for processing. It categorizes media types into `image` and `video` and validates the input against predefined lists of supported types.\n\n## Input\n- `msg.mediaType`: A string representing the media type of the asset (e.g., `image/jpeg`, `video/mp4`).\n\n## Output\n- **Output 1**: For supported media types.\n  - `msg.payload`: A success message indicating the media type is supported.\n  - `msg.statusCode`: `200` (HTTP status code for success).\n- **Output 2**: For unsupported media types or errors.\n  - `msg.payload`: An error message indicating the media type is unsupported or an internal error occurred.\n  - `msg.supportedMediaTypes`: An object listing all supported media types.\n  - `msg.statusCode`: `400` for unsupported media types, `500` for internal errors.\n\n## Logic\n1. Define supported media types for `image` and `video` categories.\n2. Extract the `mediaType` from the incoming `msg` object.\n3. Check if the `mediaType` exists in either the `image` or `video` list.\n4. If unsupported:\n   - Set an error message and include the list of supported media types.\n   - Set `msg.statusCode` to `400` and send the message to **Output 2**.\n5. If supported:\n   - Set a success message.\n   - Set `msg.statusCode` to `200` and send the message to **Output 1**.\n6. Handle unexpected errors by setting an internal error message and `msg.statusCode` to `500`.\n\n## Notes\n> Ensure the `msg.mediaType` field is provided in the input message. If missing, the function will treat it as unsupported.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "c6921afbb473bc70",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "fd02e1eb88ae35ab",
        "name": "Debug Error: Check MediaType",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1455,
        "y": 260,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "016fac0e773e7897",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "fd02e1eb88ae35ab",
        "name": "Debug OK: Check MediaType",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1455,
        "y": 140,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "2bf0e9042e6659c6",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "918806d2d79fe6e6",
        "name": "[3] 📖 Doc - Iconik Get Format",
        "info": "",
        "x": 1140,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "8e41cb773d695eb6",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "fd02e1eb88ae35ab",
        "name": "[4] 📖 Doc - Check MediaType",
        "info": "",
        "x": 1460,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "1af3f73061416777",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "fd02e1eb88ae35ab",
        "name": "Save Media type",
        "rules": [
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusInfo",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "asset_id",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1555,
        "y": 200,
        "wires": [
            [
                "378749f3f7f8db51"
            ]
        ],
        "l": false
    },
    {
        "id": "378749f3f7f8db51",
        "type": "iconik-files-client",
        "z": "bb119fa58e5b3485",
        "g": "55b3c47cc59469f5",
        "name": "GET /v1/assets/{asset_id}/proxies/",
        "selectedOperation": {
            "method": "get",
            "path": "/v1/assets/{asset_id}/proxies/",
            "summary": "Get all asset's proxies",
            "description": "Get all asset's proxies\n\nRequired roles:\n - can_read_proxies\n",
            "tag": "Other",
            "operationId": "get_v1_assets__asset_id__proxies_"
        },
        "api": "api-0",
        "errorHandlingModeSelectedIndex": 1,
        "security": [],
        "requestContentTypeSelectedIndex": 0,
        "responseContentTypeSelectedIndex": 0,
        "parameters": [
            {
                "name": "asset_id",
                "value": "iconik.webhook.asset_ids[0]",
                "in": "path",
                "refType": "msg"
            },
            {
                "name": "per_page",
                "value": "",
                "in": "query",
                "refType": "type"
            },
            {
                "name": "generate_signed_url",
                "value": "true",
                "in": "query",
                "refType": "type"
            },
            {
                "name": "content_disposition",
                "value": "attachment",
                "in": "query",
                "refType": "type"
            },
            {
                "name": "last_id",
                "value": "",
                "in": "query",
                "refType": "type"
            }
        ],
        "uiFeatures": {
            "operations": {
                "advancedMode": true
            }
        },
        "outputs": 2,
        "output": "iconik.output",
        "host": {
            "type": "string",
            "value": "",
            "refType": "type"
        },
        "x": 1695,
        "y": 200,
        "wires": [
            [
                "7e2eb0fab7bc6a69",
                "8278629e61d3b099"
            ],
            [
                "c8e84af63e546d14"
            ]
        ],
        "l": false
    },
    {
        "id": "7e2eb0fab7bc6a69",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "55b3c47cc59469f5",
        "name": "Debug OK: Get Proxies",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.output.statusCode",
        "statusType": "msg",
        "x": 1695,
        "y": 140,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "c8e84af63e546d14",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "55b3c47cc59469f5",
        "name": "Debug Error: Get Proxies",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.output.statusCode",
        "statusType": "msg",
        "x": 1695,
        "y": 260,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "8278629e61d3b099",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "55b3c47cc59469f5",
        "name": "Save Proxy Url",
        "rules": [
            {
                "t": "set",
                "p": "iconik.url",
                "pt": "msg",
                "to": "iconik.output.responseUrl",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "iconik.assetName",
                "pt": "msg",
                "to": "iconik.output.payload.objects[0].name",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "iconik.get_proxies",
                "pt": "msg",
                "to": "iconik.output",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "headers",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1775,
        "y": 200,
        "wires": [
            [
                "60f01beb32c02861"
            ]
        ],
        "l": false
    },
    {
        "id": "60f01beb32c02861",
        "type": "switch",
        "z": "bb119fa58e5b3485",
        "g": "1eba5f0f11ebce0e",
        "name": "Image or Video?",
        "property": "iconik.mediaType",
        "propertyType": "msg",
        "rules": [
            {
                "t": "cont",
                "v": "image",
                "vt": "str"
            },
            {
                "t": "cont",
                "v": "video",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 575,
        "y": 500,
        "wires": [
            [
                "1912e80aa826d7f5"
            ],
            [
                "c17bc71b9a4caec4",
                "ea7e0cc8aa8ba6ab"
            ]
        ],
        "l": false
    },
    {
        "id": "1912e80aa826d7f5",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "1eba5f0f11ebce0e",
        "name": "Debug OK: Iconik Image",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.mediaType",
        "statusType": "msg",
        "x": 575,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "c17bc71b9a4caec4",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "1eba5f0f11ebce0e",
        "name": "Debug OK: Iconik Video",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "iconik.mediaType",
        "statusType": "msg",
        "x": 575,
        "y": 560,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "f4d3219677e48ac3",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "55b3c47cc59469f5",
        "name": "[5] 📖 Doc - Get Proxies",
        "info": "",
        "x": 1760,
        "y": 80,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "c7bd865a40778920",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "1eba5f0f11ebce0e",
        "name": "[6] 📖 Doc - Mediatype",
        "info": "",
        "x": 560,
        "y": 400,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "fba603dcc61e0e8c",
        "type": "subflow:fec23f0ed22e717d",
        "z": "bb119fa58e5b3485",
        "g": "2b021cccaf858ffb",
        "name": "",
        "env": [
            {
                "name": "SUMMARY",
                "type": "bool",
                "value": "true"
            },
            {
                "name": "CAPTIONING",
                "type": "bool",
                "value": "true"
            },
            {
                "name": "MODEL",
                "value": "gemini-1.5-pro",
                "type": "str"
            }
        ],
        "x": 640,
        "y": 1800,
        "wires": [
            [
                "e77a15478f3fd4a8"
            ],
            [
                "4e556b99f052016d"
            ]
        ]
    },
    {
        "id": "e77a15478f3fd4a8",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "2b021cccaf858ffb",
        "name": "Text Generated",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 795,
        "y": 1740,
        "wires": [],
        "icon": "font-awesome/fa-exclamation-circle",
        "l": false
    },
    {
        "id": "4e556b99f052016d",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "2b021cccaf858ffb",
        "name": "Gemini Error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 865,
        "y": 1860,
        "wires": [],
        "icon": "font-awesome/fa-warning",
        "l": false
    },
    {
        "id": "34b7d8445af983fd",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "name": "Save Response",
        "rules": [
            {
                "t": "set",
                "p": "responseText.content",
                "pt": "msg",
                "to": "payload.candidates[0].content.parts[0].text",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "responseText.safetyRatings",
                "pt": "msg",
                "to": "payload.candidates[0].safetyRatings",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "responseUrl",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "userPrompt",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "url",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "apiKey",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "uploadResponse",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "mediaType",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filename",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "model",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "mediaType",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "displayName",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "noResultsFormat",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "formats",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "headers",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "fileUri",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "uploadFileName",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "retry",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "redirectList",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1560,
        "y": 1920,
        "wires": [
            [
                "4c5fb01131766919"
            ]
        ]
    },
    {
        "id": "04012d78b815481e",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Check Selected Option",
        "func": "const highlights = env.get(\"HIGHLIGHTS\"); \nconst keywords = env.get(\"KEYWORDS\");\nconst summary = env.get(\"SUMMARY\");\nconst captioning = env.get(\"CAPTIONING\");\nconst actionRecognition = env.get(\"ACTION_RECOGNITION\")\nconst selectedOptions = [];\n\nmsg.model = global.get(\"SECRETS.GEMINI_MODEL\")\n\n// Determine the selected options\nif (highlights) {\n  selectedOptions.push(\"Highlights\");\n}\nif (keywords) {\n  selectedOptions.push(\"Keywords\");\n}\nif (summary) {\n  selectedOptions.push(\"Summary\");\n}\nif(captioning){\n  selectedOptions.push(\"Video Captioning\");\n}\nif(actionRecognition){\n  selectedOptions.push(\"Video Action Recognition\");\n}\n\nmsg.selectedOptions = selectedOptions\n\n// Validate that at least one option is selected\nif (!highlights && !keywords && !summary) {\n  const errorMsg = \"You must select at least one option\";\n  node.error(errorMsg);\n  node.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n  setTimeout(() => node.status({}), 2000);\n  return [null, msg];\n}\n\n// Validate the model presence\nif (!msg.model) {\n  const errorMsg = \"You must provide a Gemini Model\";\n  node.error(errorMsg);\n  node.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n  \n  setTimeout(() => node.status({}), 2000);\n  return [null, msg];\n}\n\nreturn [msg, null];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 1980,
        "wires": [
            [
                "ed4e8db8c18ea28d"
            ],
            [
                "16148f21184c4cb9"
            ]
        ]
    },
    {
        "id": "9b217d271f42e5b2",
        "type": "template",
        "z": "bb119fa58e5b3485",
        "name": "Set Payload",
        "field": "payload",
        "fieldType": "msg",
        "format": "json",
        "syntax": "mustache",
        "template": "{\n    \"contents\": [\n        {\n            \"parts\": [\n                {\n                    \"fileData\": {\n                        \"mimeType\": \"{{{mediaType}}}\",\n                        \"fileUri\": \"{{{fileUri}}}\"\n                    }\n                }\n            ],\n            \"role\": \"user\"\n        },\n        {\n            \"parts\": [\n                {\n                    \"text\": \"{{{userPrompt}}}\"\n                }\n            ],\n            \"role\": \"user\"\n        }\n    ]\n}",
        "output": "json",
        "x": 850,
        "y": 1960,
        "wires": [
            [
                "32855f76244618c9"
            ]
        ]
    },
    {
        "id": "16148f21184c4cb9",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Set Error Response",
        "func": "const errorMsg = \"Gemini Error\"\nnode.status({fill:\"red\",shape:\"ring\",text:errorMsg});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 2000,
        "wires": [
            []
        ]
    },
    {
        "id": "17befd5a4b7f684f",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Set Success Response",
        "func": "node.status({fill:\"green\",shape:\"ring\",text:\"Success\"});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1360,
        "y": 1920,
        "wires": [
            [
                "34b7d8445af983fd"
            ]
        ]
    },
    {
        "id": "ed4e8db8c18ea28d",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Set Formats ",
        "func": "const selectedOptions = msg.selectedOptions;\nconst outputFormats = {};\n\n// Check for Object Detection\nif (selectedOptions.includes(\"Highlights\")) {\n  const highlightsFormat = [\n    {\n      \"highlight\": \"[Brief description of the important moments]\",\n      \"timestamp\": \"[Timestamp for the start and end time of the highlight in the format HH:MM:SS]\",\n      \"duration\": \"Duration of the highlight in the video\"\n    }\n  ];\n  outputFormats.highlights = highlightsFormat;\n}\n\n// Check for Optical Character Recognition (OCR)\nif (selectedOptions.includes(\"Summary\")) {\n  const summaryFormat = \"Provide a detailed summary of the key events, scenes, and main content of the video\";\n  outputFormats.summary = summaryFormat;\n}\n\n// Check for Description\nif (selectedOptions.includes(\"Keywords\")) {\n  const keywordsFormat = [\n  \"Generate a list of most relevant keywords or topics related to the video content\"\n  ];\n  outputFormats.keywords = keywordsFormat;\n}\n\n// Check for Video Captioning \nif (selectedOptions.includes(\"Video Captioning\")){\n  const videoCaptioningFormat = [\n    {\n      \"timestamp\": \"[Time in the video, e.g., '00:01:23']\",\n      \"sceneDescription\": {\n        \"overall\": \"[Description of the environment, e.g., 'A sunny park with children playing in the background']\",\n        \"objects\": [\n          {\n            \"objectName\": \"[Name of detected object, e.g., 'dog', 'tree']\",\n            \"position\": \"[Position of the object in the frame, e.g., 'center', 'top-left']\"\n          }\n        ]\n      }\n    }\n  ]\n  outputFormats.videoCaptioning = videoCaptioningFormat\n}\n\n// Check for Video Action Recognition \nif (selectedOptions.includes(\"Video Action Recognition\")){\n  const actionRecognitionFormat = [\n    {\n      \"timestamp\": \"[Time in the video, e.g., '00:02:05']\",\n      \"action\": \"[Detected action, e.g., 'running', 'jumping', etc...]\",\n      \"subject\": \"[Who is performing the action, e.g., 'man', 'child']\",\n      \"duration\": \"[Duration of the action in seconds, e.g., '3.5 seconds']\",\n      \"objectInteraction\": \"[Object being interacted with, if any, e.g., 'holding a tennis racket']\"\n    }\n  ]\n  outputFormats.actionRecognition = actionRecognitionFormat\n}\n\n// No Results Format\nconst noResultsFormat = [\n  {\n    \"option\": \"[Selected option]\",\n    \"message\": \"No descriptive content could be generated for this image.\"\n  }\n];\n\nmsg.noResultsFormat = JSON.stringify(noResultsFormat, null, 2);\nconst formattedOutput = JSON.stringify(outputFormats, null, 2);\n\nmsg.formats = formattedOutput;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 1960,
        "wires": [
            [
                "e4cfda2ae41f5038"
            ]
        ]
    },
    {
        "id": "32855f76244618c9",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "name": "Set Url",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "https://generativelanguage.googleapis.com/v1beta/models/\" & model & \":generateContent",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "authHeaders",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 990,
        "y": 1960,
        "wires": [
            [
                "d5b4a87a6cefb6c9"
            ]
        ]
    },
    {
        "id": "4c5fb01131766919",
        "type": "json",
        "z": "bb119fa58e5b3485",
        "name": "",
        "property": "responseText.content",
        "action": "",
        "pretty": false,
        "x": 1730,
        "y": 1920,
        "wires": [
            []
        ]
    },
    {
        "id": "d5b4a87a6cefb6c9",
        "type": "subflow:0876dbcda80b1dec",
        "z": "bb119fa58e5b3485",
        "name": "",
        "x": 1160,
        "y": 1960,
        "wires": [
            [
                "17befd5a4b7f684f"
            ],
            [
                "16148f21184c4cb9"
            ]
        ]
    },
    {
        "id": "056246df9904ea45",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Check Selected Option",
        "func": "// Hardcoded test values (override env and global context)\nconst highlights = true;\nconst keywords = false;\nconst summary = true;\nconst captioning = true;\nconst actionRecognition = false;\n\nconst selectedOptions = [];\n\n// Hardcoded model for testing\nmsg.model = \"models/gemini-pro-vision\"; // replace with your actual model ID if needed\n\n// Determine the selected options\nif (highlights) {\n    selectedOptions.push(\"Highlights\");\n}\nif (keywords) {\n    selectedOptions.push(\"Keywords\");\n}\nif (summary) {\n    selectedOptions.push(\"Summary\");\n}\nif (captioning) {\n    selectedOptions.push(\"Video Captioning\");\n}\nif (actionRecognition) {\n    selectedOptions.push(\"Video Action Recognition\");\n}\n\nmsg.selectedOptions = selectedOptions;\n\n// Validate that at least one option is selected\nif (!highlights && !keywords && !summary && !captioning && !actionRecognition) {\n    const errorMsg = \"You must select at least one option\";\n    node.error(errorMsg);\n    node.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n    setTimeout(() => node.status({}), 2000);\n    return [null, msg];\n}\n\n// Validate the model presence\nif (!msg.model) {\n    const errorMsg = \"You must provide a Gemini Model\";\n    node.error(errorMsg);\n    node.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n    setTimeout(() => node.status({}), 2000);\n    return [null, msg];\n}\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 975,
        "y": 1320,
        "wires": [
            [
                "c6480ce55b348f13",
                "aa06e61eb146281c"
            ],
            [
                "7d223f269faec961"
            ]
        ],
        "l": false,
        "info": "# Check Selected Option\n\n## Purpose\nThis function node validates the selected options and ensures that at least one option is chosen. It also checks for the presence of a Gemini model ID.\n\n## Input\n- No specific input fields are required, but the following are hardcoded for testing:\n  - `highlights`: Boolean indicating if the Highlights option is selected.\n  - `keywords`: Boolean indicating if the Keywords option is selected.\n  - `summary`: Boolean indicating if the Summary option is selected.\n  - `captioning`: Boolean indicating if the Video Captioning option is selected.\n  - `actionRecognition`: Boolean indicating if the Video Action Recognition option is selected.\n  - `msg.model`: The Gemini model ID (hardcoded as `models/gemini-pro-vision` for testing).\n\n## Output\n- **Output 1**: For valid selections.\n  - `msg.selectedOptions`: An array of selected options (e.g., `['Highlights', 'Summary']`).\n  - `msg.model`: The Gemini model ID.\n- **Output 2**: For errors or invalid selections.\n  - `msg.payload`: Contains the error message.\n\n## Logic\n1. Define hardcoded test values for the options (`highlights`, `keywords`, `summary`, `captioning`, `actionRecognition`).\n2. Initialize an empty array `selectedOptions` to store the selected options.\n3. Check each option and add it to `selectedOptions` if selected.\n4. Validate that at least one option is selected:\n   - If none are selected, log an error, update the node status, and send the message to **Output 2**.\n5. Validate the presence of `msg.model`:\n   - If missing, log an error, update the node status, and send the message to **Output 2**.\n6. If all validations pass, send the message to **Output 1**.\n\n## Notes\n> Replace the hardcoded values with dynamic inputs as needed for production use.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "aa06e61eb146281c",
        "type": "template",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Prompt Formats (Template)",
        "field": "payload",
        "fieldType": "msg",
        "format": "json",
        "syntax": "plain",
        "template": "{\n  \"formats\": {\n    \"Highlights\": [\n      {\n        \"highlight\": \"[Brief description of the important moments]\",\n        \"timestamp\": \"[Timestamp for the start and end time of the highlight in the format HH:MM:SS]\",\n        \"duration\": \"Duration of the highlight in the video\"\n      }\n    ],\n    \"Summary\": \"Provide a detailed summary of the key events, scenes, and main content of the video\",\n    \"Keywords\": [\n      \"Generate a list of most relevant keywords or topics related to the video content\"\n    ],\n    \"Video Captioning\": [\n      {\n        \"timestamp\": \"[Time in the video, e.g., '00:01:23']\",\n        \"sceneDescription\": {\n          \"overall\": \"[Description of the environment, e.g., 'A sunny park with children playing in the background']\",\n          \"objects\": [\n            {\n              \"objectName\": \"[Name of detected object, e.g., 'dog', 'tree']\",\n              \"position\": \"[Position of the object in the frame, e.g., 'center', 'top-left']\"\n            }\n          ]\n        }\n      }\n    ],\n    \"Video Action Recognition\": [\n      {\n        \"timestamp\": \"[Time in the video, e.g., '00:02:05']\",\n        \"action\": \"[Detected action, e.g., 'running', 'jumping', etc...]\",\n        \"subject\": \"[Who is performing the action, e.g., 'man', 'child']\",\n        \"duration\": \"[Duration of the action in seconds, e.g., '3.5 seconds']\",\n        \"objectInteraction\": \"[Object being interacted with, if any, e.g., 'holding a tennis racket']\"\n      }\n    ]\n  },\n  \"noResultsFormat\": [\n    {\n      \"option\": \"[Selected option]\",\n      \"message\": \"No descriptive content could be generated for this image.\"\n    }\n  ]\n}",
        "output": "json",
        "x": 1155,
        "y": 1320,
        "wires": [
            [
                "8f14f2d0ab60c0d3"
            ]
        ],
        "l": false
    },
    {
        "id": "8f14f2d0ab60c0d3",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Set Formats (from Template)",
        "func": "const selectedOptions = msg.selectedOptions;\nconst allFormats = msg.payload.formats || {};\nconst outputFormats = {};\n\n// Build output based on selected options\nfor (const option of selectedOptions) {\n    if (allFormats[option]) {\n        const key = option.toLowerCase().replace(/ /g, \"\");\n        outputFormats[key] = allFormats[option];\n    }\n}\n\n// Always add noResultsFormat\nmsg.noResultsFormat = JSON.stringify(msg.payload.noResultsFormat || [], null, 2);\nmsg.formats = JSON.stringify(outputFormats, null, 2);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1215,
        "y": 1320,
        "wires": [
            [
                "26b4a64ae183c139"
            ]
        ],
        "l": false
    },
    {
        "id": "c6480ce55b348f13",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Debug OK: Check Selected Option",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "selectedOptions",
        "statusType": "msg",
        "x": 975,
        "y": 1260,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "7d223f269faec961",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Debug Error: Check Selected Option",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "selectedOptions",
        "statusType": "msg",
        "x": 975,
        "y": 1380,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "0a00ea4d7c10bef4",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1960,
        "y": 1320,
        "wires": []
    },
    {
        "id": "e4cfda2ae41f5038",
        "type": "template",
        "z": "bb119fa58e5b3485",
        "name": "Set Prompt",
        "field": "userPrompt",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "Using the provided video and selected options, generate text content that accurately represents the relevant details for each option while adhering to the given formats. \nEnsure that each object is formatted properly and that redundant information is avoided.\nDo not use Markdown formatting in your output.\n\nFor each selected option, use the corresponding format as outlined below:\n-Selected options: {{{selectedOptions}}}\n-Expected format: {{{formats}}}\n\nIf no relevant results are available for any selected option, return the following format: {{noResultsFormat}}, indicating that no relevant data could be generated for the option.",
        "output": "str",
        "x": 690,
        "y": 1960,
        "wires": [
            [
                "9b217d271f42e5b2"
            ]
        ]
    },
    {
        "id": "26b4a64ae183c139",
        "type": "template",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Set Prompt",
        "field": "userPrompt",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "Using the provided video and selected options, generate text content that accurately represents the relevant details for each option while adhering to the given formats. \nEnsure that each object is formatted properly and that redundant information is avoided.\nDo not use Markdown formatting in your output.\n\nFor each selected option, use the corresponding format as outlined below:\n-Selected options: {{{selectedOptions}}}\n-Expected format: {{{formats}}}\n\nIf no relevant results are available for any selected option, return the following format: {{noResultsFormat}}, indicating that no relevant data could be generated for the option.",
        "output": "str",
        "x": 1295,
        "y": 1320,
        "wires": [
            [
                "7dea554c6ac7de37",
                "68bcce7fd6fe1421"
            ]
        ],
        "l": false
    },
    {
        "id": "6f1cabb71c4652da",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Set Url",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "authHeaders",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1495,
        "y": 1320,
        "wires": [
            [
                "41c5a0c10342a1bc"
            ]
        ],
        "l": false
    },
    {
        "id": "7271b87a36384d42",
        "type": "http request",
        "z": "bb119fa58e5b3485",
        "name": "Gemini Request",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "x-goog-api-key",
                "valueType": "msg",
                "valueValue": "apiKey"
            }
        ],
        "x": 1040,
        "y": 2160,
        "wires": [
            [
                "5b5d6bb37b9005f6"
            ]
        ]
    },
    {
        "id": "5b5d6bb37b9005f6",
        "type": "switch",
        "z": "bb119fa58e5b3485",
        "name": "Success?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "200",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1280,
        "y": 2160,
        "wires": [
            [
                "90bae9be7c39ac67"
            ],
            [
                "f514b78ed9cfc713"
            ]
        ]
    },
    {
        "id": "f514b78ed9cfc713",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Set Error Status",
        "func": "const errorMsg = \"Gemini Error\"\nnode.status({fill:\"red\",shape:\"ring\",text:errorMsg});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 2260,
        "wires": [
            []
        ]
    },
    {
        "id": "90bae9be7c39ac67",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Set Success Status",
        "func": "node.status({fill:\"green\",shape:\"ring\",text:\"Success\"});\nsetTimeout(() => {\n  node.status({});\n}, 2000);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1490,
        "y": 2160,
        "wires": [
            []
        ]
    },
    {
        "id": "41c5a0c10342a1bc",
        "type": "http request",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "Gemini Request",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "x-goog-api-key",
                "valueType": "msg",
                "valueValue": "apiKey"
            }
        ],
        "x": 1640,
        "y": 1320,
        "wires": [
            [
                "0a00ea4d7c10bef4"
            ]
        ]
    },
    {
        "id": "7dea554c6ac7de37",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1295,
        "y": 1380,
        "wires": [],
        "l": false
    },
    {
        "id": "68bcce7fd6fe1421",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "0c53975c6ac43f46",
        "name": "function 1",
        "func": "msg.payload = {\n  contents: [\n    {\n      parts: [{\n        fileData: {\n          mimeType: msg.mediaType,\n          fileUri:  msg.fileUri\n        }\n      }],\n      role: \"user\"\n    },\n    {\n      parts: [{ text: msg.userPrompt }],\n      role: \"user\"\n    }\n  ]\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1375,
        "y": 1320,
        "wires": [
            [
                "6f1cabb71c4652da"
            ]
        ],
        "l": false
    },
    {
        "id": "0efcf4cff626690b",
        "type": "delay",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "",
        "pauseType": "delay",
        "timeout": "30",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1865,
        "y": 880,
        "wires": [
            [
                "28d6c48d41f27f7f"
            ]
        ],
        "l": false
    },
    {
        "id": "41dc5b97da49fd1d",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Upload File to FileAPI(Google)",
        "func": "/**\n * Fetch Gemini file status and route the flow.\n *\n *  ▸ OUTPUT 1 → msg while state is PROCESSING  or  SUCCEEDED\n *  ▸ OUTPUT 2 → msg when state is FAILED  or any exception occurs\n *\n *  Prerequisites:\n *    • External modules enabled in Node-RED (functionExternalModules: true)\n *    • npm install @google/generative-ai   (already declared in the node)\n *    • msg.apiKey  contains your Google API key\n */\n// ──────────────────────────────────────────────────────────\n// 0.  Make sure we really have an API key and build the helper\n// ──────────────────────────────────────────────────────────\nif (!msg.apiKey || typeof msg.apiKey !== \"string\") {\n  node.error(\"Missing or invalid msg.apiKey\", msg);\n  return [ null, msg ];                 // error output (#2)\n}\n\nconst { GoogleAIFileManager } = googleGenerativeAiServer;\nconst fileManager = new GoogleAIFileManager(msg.apiKey);   // 👈 pass the *string*\n\n// ──────────────────────────────────────────────────────────\n// 1. Resolve the resource name (“files/abc123…”)\n// ──────────────────────────────────────────────────────────\nlet resourceName =\n        msg.uploadResponse?.file?.name ??                         // canonical\n        msg.gemini?.upload?.uploadResponse?.file?.name ??         // older path\n        msg.uploadResponse?.fileName ??                           // legacy\n        msg.fileName ??                                           // manual override\n        null;\n\n// Fallback: extract “…/v1beta/**files/xxx**” from a URI, if that’s all we have\nif (!resourceName) {\n    const uri =\n          msg.uploadResponse?.file?.uri ??\n          msg.gemini?.upload?.uploadResponse?.file?.uri;\n    if (uri) {\n        const parts = uri.split(\"/v1beta/\");\n        if (parts.length === 2) resourceName = parts[1];\n    }\n}\n\n// Abort if still nothing\nif (!resourceName) {\n    node.error(\"Fetch Upload Status: cannot find Gemini file resource name\", msg);\n    return [ null, msg ];          // send to error output (#2)\n}\n\n// Normalise: ensure it starts with “files/”\nif (!resourceName.startsWith(\"files/\")) {\n    resourceName = `files/${resourceName}`;\n}\n\n// ──────────────────────────────────────────────────────────\n// 2. Query Gemini  (return a Promise so Node-RED waits)\n// ──────────────────────────────────────────────────────────\nreturn fileManager.getFile(resourceName)\n  .then(file => {\n      // expose full response downstream\n      msg.file = file;\n\n      // record progress for UI / logs\n      msg.uploadResponse = msg.uploadResponse || {};\n      msg.uploadResponse.status = file.state;      // PROCESSING | SUCCEEDED | FAILED\n\n      switch (file.state) {\n          case \"FAILED\":\n              node.error(\"Gemini processing FAILED\", msg);\n              return [ null, msg ];                // error output (#2)\n\n          case \"PROCESSING\":\n          case \"SUCCEEDED\":\n              return [ msg, null ];                // success output (#1)\n\n          default:\n              node.warn(`Unexpected file state: ${file.state}`, msg);\n              return [ null, msg ];                // treat unknown as error\n      }\n  })\n.catch(err => {\n    // SDK bug: 500 + “Failed to convert server response to JSON”\n    // really means the file endpoint isn’t ready yet.\n    const msgTxt = err.message || \"\";\n    if (msgTxt.includes(\"Failed to convert server response to JSON\")) {\n        msg.uploadResponse = msg.uploadResponse || {};\n        msg.uploadResponse.status = \"PROCESSING\";   // pretend it’s still working\n        return [ msg, null ];                       // success output (#1)\n    }\n\n    node.error(`Gemini SDK error: ${msgTxt}`, msg);\n    return [ null, msg ];                           // error output (#2)\n});\n\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "googleGenerativeAiServer",
                "module": "@google/generative-ai/server"
            },
            {
                "var": "googleGenerativeAi",
                "module": "@google/generative-ai"
            }
        ],
        "x": 2005,
        "y": 880,
        "wires": [
            [
                "f509407a070a4c76",
                "35e25fd2f23e27c7"
            ],
            [
                "d8fcce508cc82af4"
            ]
        ],
        "l": false,
        "info": "# Google AI File Upload\n\n## Purpose\nThis function node uploads a file to Google AI services using the `GoogleAIFileManager` class. It allows specifying the file's MIME type and display name during the upload process.\n\n## Input\n- `msg.apiKey`: The API key for authenticating with Google AI services.\n- `msg.filename`: The name of the file to be uploaded.\n\n## Output\n- `msg.payload`: Contains the response from the file upload operation.\n  - On success: The upload response from Google AI.\n  - On failure: An error object with details about the failure.\n\n## Logic\n1. Import the `GoogleAIFileManager` class from `googleGenerativeAiServer`.\n2. Initialize the file manager with the provided API key (`msg.apiKey`).\n3. Use the `uploadFile` method to upload the file:\n   - Specify the MIME type as `video/mp4`.\n   - Use the filename (`msg.filename`) as the display name.\n4. If the upload is successful:\n   - Set the upload response as `msg.payload`.\n   - Return the updated `msg` object.\n5. If an error occurs:\n   - Log the error using `node.error`.\n   - Set an error object in `msg.payload` with details about the failure.\n   - Return the updated `msg` object.\n\n## Notes\n> Ensure that the `msg.apiKey` and `msg.filename` fields are provided in the input message. Missing fields will result in an error.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "f509407a070a4c76",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Debug OK: Fetch Status Payload",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "uploadResponse.status",
        "statusType": "msg",
        "x": 2005,
        "y": 820,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "28d6c48d41f27f7f",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Set Gemini Paramaters ",
        "rules": [
            {
                "t": "set",
                "p": "apiKey",
                "pt": "msg",
                "to": "SECRETS.GEMINI_API_KEY",
                "tot": "global"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "responseUrl",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "redirectList",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "retry",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "url",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "parts",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1925,
        "y": 880,
        "wires": [
            [
                "41dc5b97da49fd1d"
            ]
        ],
        "l": false
    },
    {
        "id": "35e25fd2f23e27c7",
        "type": "while-loop",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Is Status Active? ",
        "condi": "msg.uploadResponse.status!== \"ACTIVE\"",
        "limit": true,
        "limitTime": "60",
        "time": "counter",
        "timeType": "msg",
        "x": 2125,
        "y": 880,
        "wires": [
            [
                "cf48b48773b9aed4"
            ],
            [
                "24aa412b7d47c7c6",
                "0efcf4cff626690b"
            ]
        ],
        "l": false
    },
    {
        "id": "24aa412b7d47c7c6",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Debug OK: True",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "counter",
        "statusType": "msg",
        "x": 2125,
        "y": 940,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "cf48b48773b9aed4",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Debug OK: False",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 2125,
        "y": 820,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "d8fcce508cc82af4",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "beccbfe6d618a7ca",
        "name": "Debug Error: Fetch Status Payload",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "uploadResponse.status",
        "statusType": "msg",
        "x": 2005,
        "y": 940,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "7c4629e2b4e1baf0",
        "type": "inject",
        "z": "bb119fa58e5b3485",
        "g": "a4b528dbe3ac6232",
        "name": "Inject API key and fileName",
        "props": [
            {
                "p": "fileName",
                "v": "files/v94igcwlfwqa",
                "vt": "str"
            },
            {
                "p": "apiKey",
                "v": "AIzaSyAhoOz0EJPM2mt-MQQRZ42d3iwjjgyof4k",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1050,
        "y": 720,
        "wires": [
            [
                "dc0c5588c30a29c5"
            ]
        ]
    },
    {
        "id": "dc0c5588c30a29c5",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "a4b528dbe3ac6232",
        "name": "Build Gemini GET Request",
        "func": "// Construct Gemini File GET URL with API key\nconst baseUrl = \"https://generativelanguage.googleapis.com/v1beta/\";\nconst fileName = msg.fileName;\nconst apiKey = msg.apiKey;\n\nmsg.method = \"GET\";\nmsg.url = `${baseUrl}${fileName}?key=${apiKey}`;\nmsg.headers = {\n    \"Accept\": \"application/json\"\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 720,
        "wires": [
            [
                "f0d85a75e3e8494c"
            ]
        ]
    },
    {
        "id": "f0d85a75e3e8494c",
        "type": "http request",
        "z": "bb119fa58e5b3485",
        "g": "a4b528dbe3ac6232",
        "name": "Call Gemini Files GET",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1580,
        "y": 720,
        "wires": [
            [
                "49f0f0fa0dc4bcd7"
            ]
        ]
    },
    {
        "id": "49f0f0fa0dc4bcd7",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "a4b528dbe3ac6232",
        "name": "Metadata Response",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1810,
        "y": 720,
        "wires": []
    },
    {
        "id": "766a3fcca5fb2b44",
        "type": "exec",
        "z": "bb119fa58e5b3485",
        "g": "c69e9338a69f4b55",
        "command": "ls -lh temp_video.mp4",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 1380,
        "y": 880,
        "wires": [
            [
                "e98a084b941a301b"
            ],
            [
                "e98a084b941a301b"
            ],
            [
                "e98a084b941a301b"
            ]
        ]
    },
    {
        "id": "e98a084b941a301b",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "c69e9338a69f4b55",
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1660,
        "y": 880,
        "wires": []
    },
    {
        "id": "b31beec551160cc2",
        "type": "inject",
        "z": "bb119fa58e5b3485",
        "g": "c69e9338a69f4b55",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "",
        "x": 1190,
        "y": 860,
        "wires": [
            [
                "766a3fcca5fb2b44"
            ]
        ]
    },
    {
        "id": "ea7e0cc8aa8ba6ab",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "4a5f270e7e34714c",
        "name": "Save Auth Headers",
        "rules": [
            {
                "t": "set",
                "p": "headers",
                "pt": "msg",
                "to": "authHeaders",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "iconik.get_proxies.payload.objects[0].url",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "filePath",
                "pt": "msg",
                "to": "/tmp/temp_video.mp4",
                "tot": "str"
            }
        ],
        "x": 775,
        "y": 500,
        "wires": [
            [
                "558efa184d525b6e"
            ]
        ],
        "l": false
    },
    {
        "id": "711b16e72058a346",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "4a5f270e7e34714c",
        "name": "[7] 📖 Doc - Download Proxy",
        "info": "",
        "x": 860,
        "y": 400,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "558efa184d525b6e",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "4a5f270e7e34714c",
        "name": "Download File with Status Codes",
        "func": "const path = msg.filePath;\nconst url = msg.url;\n\nreturn new Promise((resolve, reject) => {\n    node.status({ fill: \"green\", shape: \"dot\", text: \"⬇️ Downloading...\" });\n\n    const file = fs.createWriteStream(path);\n\n    https.get(url, (response) => {\n        if (response.statusCode !== 200) {\n            msg.statusInfo = `❌ Failed to download file. Status code: ${response.statusCode}`;\n            msg.statusCode = response.statusCode;\n            node.status({ fill: \"red\", shape: \"ring\", text: `❌ Status ${response.statusCode}` });\n            return resolve([null, msg]);\n        }\n\n        response.pipe(file);\n\n        file.on(\"finish\", () => {\n            file.close(() => {\n                msg.statusInfo = `✅ File saved to ${path}`;\n                msg.filePath = path;\n                msg.statusCode = 200;\n                node.status({ fill: \"green\", shape: \"dot\", text: \"✅ Download complete\" });\n                resolve([msg, null]);\n            });\n        });\n    }).on(\"error\", (err) => {\n        try { fs.unlinkSync(path); } catch (e) {} // Clean up if file partially exists\n        msg.statusInfo = `❌ Error downloading file: ${err.message}`;\n        msg.statusCode = 400;\n        node.status({ fill: \"red\", shape: \"ring\", text: \"❌ Download error\" });\n        resolve([null, msg]);\n    });\n});\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "https",
                "module": "https"
            }
        ],
        "x": 855,
        "y": 500,
        "wires": [
            [
                "5e89b3dbf89ae519",
                "6b790f2d4a4bf3e0"
            ],
            [
                "13bc77fc3b58b316"
            ]
        ],
        "l": false,
        "info": "# Download File with Status Codes\n\n## Purpose\nThis function downloads a file from a given URL and saves it to a specified path. It handles success and error scenarios, providing appropriate status codes and messages.\n\n## Input\n- `msg.url`: The URL of the file to download.\n\n## Output\n- **Output 1 (Success)**: \n  - `msg.payload`: A success message indicating the file was saved.\n  - `msg.filePath`: The path where the file was saved.\n  - `msg.statusCode`: HTTP status code `200`.\n- **Output 2 (Error)**:\n  - `msg.payload`: An error message indicating the failure reason.\n  - `msg.statusCode`: The HTTP status code or `400` for other errors.\n\n## Logic\n1. Create a writable stream to save the file to the specified path.\n2. Use `https.get` to fetch the file from the provided URL.\n3. Check the HTTP response status code:\n   - If not `200`, send an error message to the second output.\n   - If `200`, pipe the response to the file stream.\n4. On successful download, send a success message to the first output.\n5. Handle errors during the download process and send error messages to the second output.\n\n## Notes\n> Ensure the `fs` and `https` modules are available in your environment.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "5e89b3dbf89ae519",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "4a5f270e7e34714c",
        "name": "Debug OK: Download File",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 855,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "13bc77fc3b58b316",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "4a5f270e7e34714c",
        "name": "Debug Error: Download File",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 855,
        "y": 560,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "6b790f2d4a4bf3e0",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Set Gemini Paramaters ",
        "rules": [
            {
                "t": "set",
                "p": "apiKey",
                "pt": "msg",
                "to": "SECRETS.GEMINI_API_KEY",
                "tot": "global"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "url",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "statusInfo",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1075,
        "y": 500,
        "wires": [
            [
                "f1a2b3c4d5e67890"
            ]
        ],
        "l": false
    },
    {
        "id": "f1a2b3c4d5e67890",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Prepare Upload Request with Status Outputs",
        "func": "const filePath = msg.filePath;\nconst apiKey = msg.apiKey;\n\ntry {\n    // Notify file read is starting\n    node.status({ fill: \"green\", shape: \"dot\", text: \"Reading file...\" });\n\n    // Read the file from the specified path\n    msg.payload = fs.readFileSync(filePath);\n\n    // Set headers for the upload request\n    msg.headers = {\n        \"Content-Type\": \"video/mp4\"\n    };\n\n    // Set the HTTP method and URL for the upload request\n    msg.method = \"POST\";\n    msg.url = `https://generativelanguage.googleapis.com/upload/v1beta/files?key=${apiKey}`;\n\n    // Indicate success\n    node.status({ fill: \"green\", shape: \"dot\", text: \"✅ File ready\" });\n    msg.statusCode = 200;\n    return [msg, null];\n\n} catch (error) {\n    // Handle errors (e.g., file not found)\n    msg.payload = `❌ Error preparing upload request: ${error.message}`;\n    msg.statusCode = 400;\n\n    node.status({ fill: \"red\", shape: \"ring\", text: \"❌ Read failed\" });\n    node.error(msg.payload, msg);\n\n    return [null, msg];\n}\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 1135,
        "y": 500,
        "wires": [
            [
                "6db4c154c084378c",
                "f5c76e4a184c6ffd"
            ],
            [
                "38880de9afe4fd3a"
            ]
        ],
        "l": false,
        "info": "# Prepare Upload Request with Status Outputs\n\n## Purpose\nThis function prepares an HTTP POST request to upload a video file to the Google Generative Language API. It handles success and error scenarios, providing appropriate status codes and messages.\n\n## Input\n- `msg.filePath`: The path to the file to be uploaded.\n\n## Output\n- **Output 1 (Success)**:\n  - `msg.payload`: The binary content of the video file.\n  - `msg.headers`: HTTP headers for the upload request, including the `Content-Type`.\n  - `msg.method`: The HTTP method, set to `POST`.\n  - `msg.url`: The API endpoint URL, including the API key.\n  - `msg.statusCode`: HTTP status code `200`.\n- **Output 2 (Error)**:\n  - `msg.payload`: An error message indicating the failure reason.\n  - `msg.statusCode`: HTTP status code `400`.\n\n## Logic\n1. Read the video file from the specified path using `fs.readFileSync`.\n2. Set the `Content-Type` header to `video/mp4`.\n3. Configure the HTTP method as `POST`.\n4. Construct the API endpoint URL with the provided API key.\n5. If successful, send the prepared `msg` object to the first output with a `200` status code.\n6. If an error occurs (e.g., file not found), send an error message to the second output with a `400` status code.\n\n## Notes\n> Ensure the `fs` module is available in your environment and the file path is correct.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "6db4c154c084378c",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Debug OK: Upload Payload",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1135,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "38880de9afe4fd3a",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Debug Error: Upload Payload",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1135,
        "y": 560,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "01b66cb140e416c2",
        "type": "http request",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Upload File",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1275,
        "y": 500,
        "wires": [
            [
                "3510ebc7baaa1485"
            ]
        ],
        "l": false
    },
    {
        "id": "3510ebc7baaa1485",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Debug OK: Upload File",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1275,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "f5c76e4a184c6ffd",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Set Gemini Paramaters ",
        "rules": [
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1215,
        "y": 500,
        "wires": [
            [
                "4116f467356ceb1b"
            ]
        ],
        "l": false
    },
    {
        "id": "bffb661f516fb5b5",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "[8] 📖 Doc - Upload Proxy",
        "info": "",
        "x": 1210,
        "y": 400,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "aea43ccdf90168cd",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "2e5787e38e3bb178",
        "name": "Set Gemini Paramaters ",
        "rules": [
            {
                "t": "set",
                "p": "gemini.upload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filePath",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "method",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "url",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "responseUrl",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "redirectList",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "retry",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "headers",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1355,
        "y": 500,
        "wires": [
            [
                "737e8c1dced31d50"
            ]
        ],
        "l": false
    },
    {
        "id": "737e8c1dced31d50",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Set Gemini Paramaters ",
        "rules": [
            {
                "t": "set",
                "p": "apiKey",
                "pt": "msg",
                "to": "SECRETS.GEMINI_API_KEY",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "filename",
                "pt": "msg",
                "to": "gemini.upload.file.name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1455,
        "y": 500,
        "wires": [
            [
                "8d519cd6a3836e1c"
            ]
        ],
        "l": false
    },
    {
        "id": "8d519cd6a3836e1c",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Build Gemini GET Request with Status Outputs",
        "func": "// Construct Gemini File GET URL with API key\nconst baseUrl = \"https://generativelanguage.googleapis.com/v1beta/\";\nconst filename = msg.filename;\nconst apiKey = msg.apiKey;\n\ntry {\n    // Validate required inputs\n    if (!filename || !apiKey) {\n        throw new Error(\"Missing required parameters: filename or apiKey\");\n    }\n\n    // Build the GET request\n    msg.method = \"GET\";\n    msg.url = `${baseUrl}${filename}?key=${apiKey}`;\n    msg.headers = {\n        \"Accept\": \"application/json\"\n    };\n\n    // Indicate success and send to the first output\n    msg.statusCode = 200;\n    return [msg, null];\n} catch (error) {\n    // Handle errors, such as missing parameters\n    msg.payload = `❌ Error building GET request: ${error.message}`;\n    msg.statusCode = 400;\n    node.error(msg.payload, msg);\n    return [null, msg]; // Send to the second output for errors\n}",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1595,
        "y": 500,
        "wires": [
            [
                "24ec17f135c032fd",
                "de764c04e9e20758"
            ],
            [
                "f7237e0709b112c6"
            ]
        ],
        "l": false,
        "info": "# Build Gemini GET Request with Status Outputs\n\n## Purpose\nThis function constructs a GET request to retrieve a file from the Gemini API. It handles success and error scenarios, providing appropriate status codes and messages.\n\n## Input\n- `msg.fileName`: The name of the file to retrieve.\n- `msg.apiKey`: The API key for authentication.\n\n## Output\n- **Output 1 (Success)**:\n  - `msg.method`: The HTTP method, set to `GET`.\n  - `msg.url`: The constructed API endpoint URL.\n  - `msg.headers`: HTTP headers for the request, including `Accept: application/json`.\n  - `msg.statusCode`: HTTP status code `200`.\n- **Output 2 (Error)**:\n  - `msg.payload`: An error message indicating the failure reason.\n  - `msg.statusCode`: HTTP status code `400`.\n\n## Logic\n1. Validate that `fileName` and `apiKey` are provided.\n2. Construct the GET request URL using the base URL, file name, and API key.\n3. Set the HTTP method to `GET` and add the `Accept` header.\n4. If successful, send the prepared `msg` object to the first output with a `200` status code.\n5. If an error occurs (e.g., missing parameters), send an error message to the second output with a `400` status code.\n\n## Notes\n> Ensure that `fileName` and `apiKey` are included in the incoming `msg` object.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "24ec17f135c032fd",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Debug OK: Payload Get File",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1595,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "f7237e0709b112c6",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Debug Error: Payload Get File",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1595,
        "y": 560,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "de764c04e9e20758",
        "type": "http request",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Call Gemini Files GET",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1695,
        "y": 500,
        "wires": [
            [
                "49237eea06f5ac58",
                "c60188f556a94408"
            ]
        ],
        "l": false
    },
    {
        "id": "ab7d56461f19d6b5",
        "type": "delay",
        "z": "bb119fa58e5b3485",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1995,
        "y": 480,
        "wires": [
            [
                "6512a0b82795e4c1"
            ]
        ],
        "l": false
    },
    {
        "id": "87ba8df0de8b710d",
        "type": "comment",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "[9] 📖 Doc - Get File",
        "info": "",
        "x": 1610,
        "y": 400,
        "wires": [],
        "icon": "font-awesome/fa-book"
    },
    {
        "id": "49237eea06f5ac58",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Debug OK: Get File",
        "active": false,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusCode",
        "statusType": "msg",
        "x": 1695,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "c60188f556a94408",
        "type": "change",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Set Gemini Paramaters ",
        "rules": [
            {
                "t": "set",
                "p": "gemini.getFile",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "statusCode",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filename",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "method",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "url",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "responseUrl",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "redirectList",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "retry",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "headers",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1775,
        "y": 500,
        "wires": [
            [
                "d4e5f6a7b8c90123"
            ]
        ],
        "l": false
    },
    {
        "id": "11903d3ecab11bc8",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "name": "Debug OK: State",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusInfo",
        "statusType": "msg",
        "x": 1895,
        "y": 440,
        "wires": [],
        "icon": "font-awesome/fa-check-circle-o",
        "l": false
    },
    {
        "id": "d4e5f6a7b8c90123",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "Handle File State",
        "func": "const fileState = msg.gemini.getFile.state;\n\nswitch (fileState) {\n    case \"PROCESSING\":\n        msg.statusCode = 102; // Processing\n        msg.statusInfo = \"PROCESSING\";\n        return [msg, null, null, null];\n    case \"ACTIVE\":\n        msg.statusCode = 200; // OK\n        msg.statusInfo = \"ACTIVE\";\n        return [null, msg, null, null];\n    case \"FAILED\":\n        msg.statusCode = 500; // Server Error\n        msg.statusInfo = \"FAILED\";\n        return [null, null, msg, null];\n    case \"STATE_UNSPECIFIED\":\n    default:\n        msg.statusCode = 400; // Bad Request / Unknown\n        msg.statusInfo = \"STATE_UNSPECIFIED\";\n        return [null, null, null, msg];\n}",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1895,
        "y": 500,
        "wires": [
            [
                "11903d3ecab11bc8",
                "ab7d56461f19d6b5"
            ],
            [
                "11903d3ecab11bc8"
            ],
            [
                "39f07156ad43064d"
            ],
            [
                "39f07156ad43064d"
            ]
        ],
        "l": false,
        "info": "# Handle File State\n\n## Purpose\nThis function processes the state of a file and routes the message to one of four outputs based on the state. It also assigns an appropriate HTTP status code to the message payload.\n\n## Input\n- `msg.payload.state`: The state of the file. Possible values:\n  - `PROCESSING`\n  - `ACTIVE`\n  - `FAILED`\n  - `STATE_UNSPECIFIED` (or any other unknown state)\n\n## Output\n- **Output 1 (Processing)**:\n  - `msg.payload.statusCode`: `102` (Processing).\n- **Output 2 (Active)**:\n  - `msg.payload.statusCode`: `200` (OK).\n- **Output 3 (Failed)**:\n  - `msg.payload.statusCode`: `500` (Server Error).\n- **Output 4 (Unspecified/Default)**:\n  - `msg.payload.statusCode`: `400` (Bad Request / Unknown).\n\n## Logic\n1. Check the value of `msg.payload.state`.\n2. Based on the state:\n   - If `PROCESSING`, set `statusCode` to `102` and send to the first output.\n   - If `ACTIVE`, set `statusCode` to `200` and send to the second output.\n   - If `FAILED`, set `statusCode` to `500` and send to the third output.\n   - If `STATE_UNSPECIFIED` or any other unknown state, set `statusCode` to `400` and send to the fourth output.\n\n## Notes\n> Ensure that `msg.payload.state` is included in the incoming message.\n\n## Author\n[Created by francois.brisson@qibb.com](mailto:francois.brisson@qibb.com)\n\n## qibb Docs\n[📚 qibb Platform Documentation](https://docs.qibb.com/platform/latest/)"
    },
    {
        "id": "6512a0b82795e4c1",
        "type": "link call",
        "z": "bb119fa58e5b3485",
        "name": "State Processing",
        "links": [
            "40c124dd6121de0e"
        ],
        "linkType": "static",
        "timeout": "30",
        "x": 2055,
        "y": 480,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "40c124dd6121de0e",
        "type": "link in",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "Get File State",
        "links": [],
        "x": 1455,
        "y": 560,
        "wires": [
            [
                "737e8c1dced31d50",
                "b55083f2ef45d619"
            ]
        ]
    },
    {
        "id": "b55083f2ef45d619",
        "type": "link out",
        "z": "bb119fa58e5b3485",
        "g": "0c30a2997401eb5a",
        "name": "State Call Return",
        "mode": "return",
        "links": [],
        "x": 1515,
        "y": 560,
        "wires": []
    },
    {
        "id": "39f07156ad43064d",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "name": "Debug Error: State",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "statusInfo",
        "statusType": "msg",
        "x": 1895,
        "y": 560,
        "wires": [],
        "icon": "node-red/alert.svg",
        "l": false
    },
    {
        "id": "4116f467356ceb1b",
        "type": "function",
        "z": "bb119fa58e5b3485",
        "name": "function 2",
        "func": "const filePath = msg.filePath;\nconst apiKey = msg.apiKey;\nconst url = new urlLib.URL(`https://generativelanguage.googleapis.com/upload/v1beta/files?key=${apiKey}`);\n\n// Progress tracking\nlet totalSize = fs.statSync(filePath).size;\nlet uploaded = 0;\n\nconst readStream = fs.createReadStream(filePath);\nconst options = {\n    method: \"POST\",\n    headers: {\n        \"Content-Type\": \"video/mp4\",\n        \"Content-Length\": totalSize\n    }\n};\n\nconst req = https.request(url, options, (res) => {\n    let response = \"\";\n\n    res.on(\"data\", chunk => response += chunk);\n\n    res.on(\"end\", () => {\n        try {\n            msg.payload = JSON.parse(response);\n        } catch (err) {\n            msg.payload = response;\n            msg.parseError = true;\n        }\n\n        msg.statusCode = res.statusCode;\n        node.status({ fill: \"green\", shape: \"dot\", text: `✅ Upload complete` });\n        node.send([msg, null]);\n    });\n});\n\nreq.on(\"error\", (err) => {\n    msg.payload = `❌ Upload failed: ${err.message}`;\n    msg.statusCode = 500;\n    node.status({ fill: \"red\", shape: \"ring\", text: \"❌ Upload error\" });\n    node.error(msg.payload, msg);\n    node.send([null, msg]);\n});\n\nreadStream.on(\"data\", (chunk) => {\n    uploaded += chunk.length;\n    let percent = Math.round((uploaded / totalSize) * 100);\n    node.status({ fill: \"blue\", shape: \"dot\", text: `Uploading: ${percent}%` });\n});\n\nreadStream.pipe(req);\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "https",
                "module": "https"
            },
            {
                "var": "path",
                "module": "path"
            },
            {
                "var": "urlLib",
                "module": "url"
            }
        ],
        "x": 1240,
        "y": 640,
        "wires": [
            [
                "aea43ccdf90168cd",
                "5cd18aa49876764b"
            ]
        ]
    },
    {
        "id": "5cd18aa49876764b",
        "type": "debug",
        "z": "bb119fa58e5b3485",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1480,
        "y": 640,
        "wires": []
    }
]